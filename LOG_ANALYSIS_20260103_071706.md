# 日志分析报告 - driver_20260103_071706.log

## 时间线分析

| 时间 | 事件 | 耗时 | 状态 |
|------|------|------|------|
| 07:17:32 | ask: start | - | - |
| 07:18:11 | ensure_ready done | 38.57s | ❌ 目标: <10s |
| 07:18:13 | ensure_variant done | 2.00s | ✓ |
| 07:18:20 | creating new chat | - | - |
| 07:18:32 | new_chat: textarea appeared | 12s | ❌ 目标: <5s |
| 07:18:34 | sending prompt | - | - |
| 07:19:01 | send phase done | 26.79s | ❌ 目标: <15s |
| 07:19:01 | assistant wait done | 0.67s | ✓ |
| 07:19:01 | content wait done | 0.11s | ✓ |
| 07:19:01 | waiting output stabilize | - | - |
| 07:19:12 | generating=True, len=49 | 11s | - |
| 07:22:28 | done (stabilized) | 207s | ❌ 内容只有49字符，但generating=True持续很久 |

## 关键性能问题

### 1. ensure_ready: 38.57秒 ❌
- **问题**：第一次调用耗时过长
- **原因**：检查频率不够高，等待间隔过长
- **优化**：
  - 提高检查频率：从 0.08/0.15秒 减少到 0.05/0.12秒
  - 前8次快速检查（0.05秒），之后0.12秒

### 2. new_chat: 12秒 ❌
- **问题**：等待textarea出现耗时12秒
- **原因**：使用`wait_for_selector`，超时时间过长（10秒）
- **优化**：
  - 使用高频轮询检查（每50ms检查一次）
  - 最多等待5秒，然后fallback到`wait_for_selector`（但超时时间更短）
  - 减少固定等待时间：从0.5秒减少到0.3秒，从0.3秒减少到0.2秒

### 3. send phase: 26.79秒 ❌
- **问题**：fast path失败，fallback到legacy path
- **原因**：
  - 高频轮询超时时间过长（2.0秒）
  - 第二次尝试的超时时间也过长（1.0秒）
- **优化**：
  - 减少第一次高频轮询超时：从2.0秒减少到1.5秒
  - 减少第二次尝试超时：从1.0秒减少到0.8秒
  - 加快失败检测，更快fallback到legacy path

### 4. output stabilize: 约207秒（3.5分钟）❌
- **问题**：内容长度一直是49字符，但`generating=True`持续了约3.5分钟
- **原因**：`_is_generating()`可能误判，或者需要添加"内容长时间不变"的检测逻辑
- **优化**：
  - 添加"内容长度长时间不变（>30秒）"检测
  - 如果内容超过30秒没有变化，即使`generating=True`，也认为已经稳定
  - 这可以避免`_is_generating()`误判导致的长时间等待

## 优化措施

### 1. 优化 output stabilize 逻辑
```python
# 关键优化：如果内容长度长时间不变（>30秒），即使generating=True，也应该认为已经稳定
time_since_change = time.time() - last_change
if current_len > 0 and time_since_change >= 30.0:
    # 内容超过30秒没有变化，即使generating=True，也认为已经稳定
    self._log(f"ask: content unchanged for {time_since_change:.1f}s (len={current_len}), forcing stabilization even if generating={generating}")
    # ... 返回结果
```

### 2. 优化 ensure_ready 检查频率
```python
# 从 0.08/0.15秒 减少到 0.05/0.12秒
sleep_time = 0.05 if check_count < 8 else 0.12
```

### 3. 优化 new_chat 等待逻辑
```python
# 使用高频轮询检查（每50ms检查一次），而不是wait_for_selector
check_interval = 0.05  # 每50ms检查一次
max_wait_s = 5.0  # 最多等待5秒
```

### 4. 优化 send phase fast path
```python
# 减少高频轮询超时时间
max_attempts = 300  # 1.5秒 / 0.005秒 = 300次（从400次减少）
# 第二次尝试
for attempt in range(160):  # 0.8秒 / 0.005秒 = 160次（从200次减少）
```

## 预期效果

1. **ensure_ready**: 从38.57秒优化到 <10秒
2. **new_chat**: 从12秒优化到 <5秒
3. **send phase**: 从26.79秒优化到 <15秒
4. **output stabilize**: 从207秒优化到 <30秒（如果内容长时间不变）

## 测试建议

1. 重新运行`chatlog_automation`，观察性能改进
2. 特别关注：
   - ensure_ready耗时是否降低
   - new_chat耗时是否降低
   - send phase耗时是否降低
   - output stabilize是否在内容长时间不变时更快返回

