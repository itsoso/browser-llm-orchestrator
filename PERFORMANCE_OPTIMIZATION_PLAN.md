# 性能优化计划（基于日志分析）

## 关键性能瓶颈分析

### 1. Gemini ensure_ready 首次启动慢（46.90秒）【高优先级】

**问题**：
- 首次启动时 `ensure_ready` 用了 46.90 秒
- 后续请求只需 0.37-2.15 秒
- `_find_textbox()` 每次调用都会先 `_dismiss_popups()`，然后串行检查多个选择器
- 每个选择器都有 500ms 的 `is_visible` 超时，如果页面还在加载会反复失败

**优化方案**：
1. **并行检查多个选择器**：使用 `asyncio.gather()` 同时检查所有选择器，取第一个成功的结果
2. **减少初始等待时间**：从 0.5 秒减少到 0.2 秒
3. **优化弹窗清理频率**：只在必要时清理弹窗（例如每 5 次检查一次，而不是每次）
4. **添加快速路径**：如果页面已经加载完成（`load_state` 为 `domcontentloaded`），直接检查输入框

**预期效果**：
- 首次启动时间从 47 秒减少到 5-10 秒
- 后续请求保持 0.5-2 秒

### 2. ChatGPT ensure_ready 首次启动慢（37.37秒）【高优先级】

**问题**：
- 首次启动时 `ensure_ready` 用了 37.37 秒
- 后续请求只需 0.47 秒
- `_find_textbox_any_frame()` 需要遍历多个 frame 和选择器，串行执行很慢

**优化方案**：
1. **并行检查多个 frame 和选择器**：使用 `asyncio.gather()` 同时检查所有 frame 和选择器组合
2. **优化 frame 优先级**：优先检查主 frame，减少不必要的 frame 遍历
3. **添加快速路径**：如果主 frame 已经找到输入框，直接返回，不遍历其他 frame

**预期效果**：
- 首次启动时间从 37 秒减少到 3-5 秒
- 后续请求保持 0.5 秒以内

### 3. ChatGPT assistant_count() 超时频繁（33秒等待）【高优先级】

**问题**：
- 日志显示多次 `assistant_count() timeout, retrying...`
- 等待了 33 秒才检测到新消息
- 说明并行优化可能没有完全生效，或者选择器本身就很慢

**优化方案**：
1. **检查 base.py 中的并行实现**：确认 `_assistant_count()` 是否真的使用了并行
2. **减少单个选择器超时**：从 3 秒减少到 1-2 秒
3. **添加快速检测机制**：如果 `user_count` 已经增加，直接检查文本内容，不需要等待 `assistant_count`
4. **优化选择器顺序**：将最常用的选择器放在前面

**预期效果**：
- `assistant_count()` 调用时间从 8-33 秒减少到 1-3 秒
- 新消息检测时间从 33 秒减少到 3-5 秒

### 4. Gemini new_chat 不稳定（7-20秒）【中优先级】

**问题**：
- `new_chat()` 耗时不稳定：7.19秒、12.10秒、20.30秒、9.74秒
- 没有明确的等待条件，只是固定 sleep
- 点击按钮后，页面可能需要时间更新

**优化方案**：
1. **添加明确的等待条件**：点击按钮后，等待输入框重新出现或页面 URL 变化
2. **减少固定 sleep**：从 1.0 秒减少到 0.5 秒，但添加条件等待
3. **优化按钮选择器**：确保点击的是正确的新对话按钮

**预期效果**：
- `new_chat()` 时间从 7-20 秒减少到 2-5 秒
- 时间更稳定，减少波动

### 5. Gemini 发送按钮警告（内容未清空）【中优先级】

**问题**：
- `warning - textbox still has content after button click`
- 说明按钮点击后，内容没有清空，可能发送失败
- 需要更可靠的发送确认机制

**优化方案**：
1. **增强发送确认逻辑**：检查输入框内容是否清空，如果未清空，尝试其他发送方法（Enter、Ctrl+Enter）
2. **添加重试机制**：如果第一次点击失败，等待 1 秒后重试
3. **优化按钮状态检查**：点击前检查按钮是否可点击（不是 disabled）

**预期效果**：
- 减少发送失败的情况
- 提高发送成功率

### 6. ChatGPT JS clear 超时【中优先级】

**问题**：
- `JS clear failed: TimeoutError`
- 清空操作超时，可能影响后续输入

**优化方案**：
1. **减少清空超时时间**：从 5 秒减少到 2 秒
2. **添加 fallback 机制**：如果 JS 清空失败，使用 `fill("")` 或 `clear()` 方法
3. **优化清空逻辑**：只清空必要的元素，减少不必要的操作

**预期效果**：
- 减少清空超时错误
- 提高清空成功率

### 7. ChatGPT 用户消息确认慢（46.45秒）【中优先级】

**问题**：
- 第一次请求时，用户消息确认用了 46.45 秒（触发了手动检查点）
- 第二次请求用了 17.85 秒
- `user_count()` 检测仍然很慢

**优化方案**：
1. **优化 user_count() 并行实现**：确认是否真的使用了并行
2. **减少重试间隔**：从 0.15 秒减少到 0.1 秒
3. **添加快速检测机制**：如果 `assistant_count` 已经增加，直接跳过 `user_count` 检测

**预期效果**：
- 用户消息确认时间从 17-46 秒减少到 3-5 秒

## 实施优先级

1. **高优先级**（立即实施）：
   - Gemini ensure_ready 并行优化
   - ChatGPT ensure_ready 并行优化
   - ChatGPT assistant_count() 并行优化

2. **中优先级**（后续实施）：
   - Gemini new_chat 优化
   - Gemini 发送按钮确认优化
   - ChatGPT JS clear 优化
   - ChatGPT 用户消息确认优化

## 预期总体效果

- **首次启动时间**：从 47 秒（Gemini）+ 37 秒（ChatGPT）= 84 秒减少到 10-15 秒
- **后续请求时间**：保持 0.5-2 秒
- **消息确认时间**：从 17-46 秒减少到 3-5 秒
- **新消息检测时间**：从 33 秒减少到 3-5 秒
- **总体任务时间**：从 1.6 分钟减少到 1.0-1.2 分钟

