# Prompt 模板管理使用指南

## 📖 概述

Prompt 模板管理系统允许你为不同的群聊和 LLM 创建自定义的分析模板，实现更精准和个性化的群聊分析。

## ✨ 核心特性

### 1. 模板管理
- **创建模板**：定义自己的 Prompt 模板
- **基础模板与扩展**：支持模板继承，避免重复编写
- **LLM 特定模板**：为 ChatGPT、Gemini 分别定制
- **系统内置模板**：提供开箱即用的默认模板

### 2. 群聊-模板映射
- **灵活映射**：为不同群聊指定不同的分析模板
- **优先级控制**：支持映射优先级设置
- **动态切换**：运行时自动应用对应模板

### 3. 模板层级
```
基础模板（通用）
 ├── ChatGPT 扩展模板
 ├── Gemini 扩展模板
 └── 自定义扩展模板
```

## 🚀 快速开始

### 访问模板管理界面

1. 启动 Web Admin：
```bash
python web_admin.py
```

2. 浏览器访问：
```
http://127.0.0.1:5050
```

3. 点击 **🎨 模板管理** 标签

## 📝 使用教程

### 场景 1：创建独立模板

**适用情况**：为某个特定群聊创建完全独立的分析模板

**步骤**：

1. 点击 **➕ 新建模板**
2. 填写表单：
   - **模板 ID**：`book_club_analysis`（唯一标识，只能包含小写字母、数字、下划线）
   - **模板名称**：`读书会群聊分析`
   - **描述**：`专门用于分析读书会群聊，关注书籍讨论和读书进度`
   - **LLM 类型**：选择 `通用` 或特定 LLM
   - **基础模板**：选择 `无（独立模板）`
   - **模板内容**：
     ```markdown
     你是一个读书会群聊分析助手。请重点关注：
     
     ## 分析重点
     
     1. **书籍讨论**
        - 正在讨论哪些书籍
        - 成员的阅读进度
        - 对书籍的评价和观点
     
     2. **活动安排**
        - 线下聚会计划
        - 下次读书会时间和地点
        - 待读书单
     
     3. **互动质量**
        - 讨论深度
        - 成员参与度
        - 有价值的观点摘录
     
     ## 输出格式
     
     使用 Markdown，包含：
     - 本周讨论的书籍清单
     - 精彩观点摘要
     - 待办事项（活动、下期书单等）
     ```
3. 点击 **保存**

### 场景 2：创建扩展模板（基于系统模板）

**适用情况**：在系统默认模板基础上添加特定需求

**步骤**：

1. 点击 **➕ 新建模板**
2. 填写表单：
   - **模板 ID**：`tech_chat_extended`
   - **模板名称**：`技术群聊扩展分析`
   - **LLM 类型**：`ChatGPT`
   - **基础模板**：选择 `微信群聊分析（ChatGPT 优化）`
   - **模板内容**（追加内容）：
     ```markdown
     ## 技术群聊特定要求
     
     - 识别技术问题和解决方案
     - 提取代码片段和技术资源链接
     - 总结技术讨论的结论
     - 标注未解决的技术问题
     ```
3. 点击 **保存**

**效果**：最终模板 = 基础模板内容 + 扩展内容

### 场景 3：为群聊设置自定义模板

**步骤**：

1. 创建好模板后，点击右侧 **➕ 新建映射**
2. 填写映射关系：
   - **群聊名称**：从下拉列表选择（例如：`桃园林读书会4.0`）
   - **模板**：选择刚创建的模板（例如：`读书会群聊分析`）
   - **LLM 类型（可选）**：留空使用模板默认值，或指定特定 LLM
3. 点击 **保存**

**效果**：该群聊在进行每日复盘时，将自动使用指定的模板进行分析

### 场景 4：针对不同 LLM 使用不同模板

**步骤**：

1. 为同一个群聊创建两个映射：
   - 映射 1：群聊 = `XX群`，模板 = `模板A`，LLM = `ChatGPT`
   - 映射 2：群聊 = `XX群`，模板 = `模板B`，LLM = `Gemini`

2. 在每日复盘时：
   - 选择 ChatGPT → 自动使用模板A
   - 选择 Gemini → 自动使用模板B

**注意**：同一个群聊只能有一个映射，新映射会覆盖旧映射。

## 🎨 模板编写技巧

### 1. 使用变量（未来支持）

模板中可以使用以下占位符：
- `{{talker}}`：群聊名称
- `{{date_range}}`：日期范围
- `{{message_count}}`：消息数量

### 2. 模板内容建议

#### ✅ 好的模板
```markdown
## 分析目标
明确说明分析的重点和目的

## 输出结构
定义清晰的输出格式和章节

## 特殊要求
针对该群聊的特定关注点
```

#### ❌ 避免
- 过于宽泛、没有针对性
- 输出格式不明确
- 缺少具体指令

### 3. LLM 特定优化

#### ChatGPT
- 简洁明了的指令
- 使用表情符号增强可读性
- 重点突出关键信息

#### Gemini
- 更详细的上下文说明
- 结构化的输出要求
- 正式的语言风格

## 📊 系统内置模板

### 1. `system_base_chatlog`
- **类型**：基础模板
- **LLM**：通用
- **用途**：标准的群聊分析框架
- **特点**：系统模板，不可修改或删除

### 2. `system_chatgpt_chatlog`
- **类型**：扩展模板
- **基础**：`system_base_chatlog`
- **LLM**：ChatGPT
- **特点**：针对 ChatGPT 的优化建议

### 3. `system_gemini_chatlog`
- **类型**：扩展模板
- **基础**：`system_base_chatlog`
- **LLM**：Gemini
- **特点**：针对 Gemini 的优化建议

## 🔧 API 使用（高级）

### 创建模板
```bash
curl -X POST http://127.0.0.1:5050/api/templates \
  -H "Content-Type: application/json" \
  -d '{
    "id": "my_template",
    "name": "我的模板",
    "description": "自定义分析模板",
    "llm_type": "chatgpt",
    "content": "你是...",
    "base_template_id": null
  }'
```

### 获取模板列表
```bash
curl http://127.0.0.1:5050/api/templates
```

### 获取模板完整内容（含继承）
```bash
curl http://127.0.0.1:5050/api/templates/my_template/content
```

### 创建映射
```bash
curl -X POST http://127.0.0.1:5050/api/template-mappings \
  -H "Content-Type: application/json" \
  -d '{
    "talker": "读书会群",
    "template_id": "book_club_analysis",
    "llm_type": null
  }'
```

### 查看映射列表
```bash
curl http://127.0.0.1:5050/api/template-mappings
```

## 💡 最佳实践

### 1. 模板组织策略

#### 推荐的模板层级结构
```
system_base_chatlog（系统基础）
├── system_chatgpt_chatlog（系统 ChatGPT）
│   └── tech_chatgpt_extended（你的技术群扩展）
├── system_gemini_chatlog（系统 Gemini）
│   └── book_gemini_extended（你的读书会扩展）
└── company_base（你的公司群基础）
    ├── project_a_template（项目A模板）
    └── project_b_template（项目B模板）
```

### 2. 命名规范

- **模板 ID**：`类别_用途_llm`（例如：`book_club_analysis_chatgpt`）
- **模板名称**：中文，简洁明了
- **描述**：说明适用场景和特点

### 3. 迭代优化

1. **初始版本**：使用系统模板
2. **观察效果**：看分析结果是否满足需求
3. **创建扩展**：在基础模板上添加特定需求
4. **持续改进**：根据实际效果调整模板内容

### 4. 多群聊管理

| 群聊类型 | 推荐模板策略 |
|---------|------------|
| 技术讨论群 | 技术特定模板，关注问题/解决方案 |
| 读书会群 | 读书特定模板，关注书籍/讨论 |
| 工作项目群 | 项目管理模板，关注任务/进度 |
| 家庭/朋友群 | 通用模板或简化模板 |

## ⚠️ 注意事项

### 1. 系统模板保护
- 系统内置模板（`system_*`）不可编辑或删除
- 可以基于系统模板创建扩展

### 2. 模板依赖
- 删除被其他模板依赖的基础模板会失败
- 建议先解除依赖关系再删除

### 3. 映射覆盖
- 同一个群聊只能有一个有效映射
- 新建映射会自动覆盖旧映射

### 4. 模板文件
- 模板存储在 `data/templates/` 目录
- `templates.json`：所有模板定义
- `mappings.json`：群聊-模板映射关系

## 🐛 故障排查

### 问题 1：模板不生效
**症状**：创建了映射，但复盘还是用默认模板

**排查**：
1. 检查映射是否创建成功：访问"模板管理" → "群聊-模板映射"
2. 查看日志：`logs/daily_recap_*.log` 中搜索 "自定义模板"
3. 确认群聊名称完全匹配（大小写敏感）

### 问题 2：模板ID冲突
**症状**：创建模板时提示"模板 ID 已存在"

**解决**：使用不同的 ID，或删除旧模板后重试

### 问题 3：基础模板循环依赖
**症状**：创建扩展模板时出错

**解决**：检查模板继承关系，不能出现循环（A→B→A）

## 📚 相关文档

- [每日复盘使用指南](./DAILY_RECAP_USAGE.md)
- [Web 管理界面使用说明](./WEB_ADMIN_USAGE.md)
- [Chatlog 集成文档](./CHATLOG_INTEGRATION_DESIGN.md)

## 🎯 示例场景

### 示例 1：技术团队

**场景**：公司有多个技术项目群，希望提取技术问题和解决方案

**实现**：
1. 创建基础模板 `tech_base`（技术讨论通用框架）
2. 为每个项目创建扩展：`project_a_tech`、`project_b_tech`
3. 建立映射：
   - 项目A群 → `project_a_tech`
   - 项目B群 → `project_b_tech`

### 示例 2：读书社群

**场景**：读书会群需要关注书籍讨论和活动安排

**实现**：
1. 创建独立模板 `book_club_analysis`
2. 模板内容重点：
   - 书籍讨论摘要
   - 成员观点提取
   - 活动计划整理
3. 建立映射：读书会群 → `book_club_analysis`

### 示例 3：多LLM对比

**场景**：同一个群聊，想对比 ChatGPT 和 Gemini 的分析效果

**实现**：
1. 创建 ChatGPT 特定模板（简洁风格）
2. 创建 Gemini 特定模板（详细风格）
3. 在每日复盘时勾选两个LLM，系统会自动使用对应模板

## 🚀 高级用法

### 1. 批量管理

如果需要为多个群聊批量设置模板，可以直接编辑 `data/templates/mappings.json`：

```json
[
  {
    "talker": "技术群1",
    "template_id": "tech_base",
    "llm_type": null,
    "priority": 0,
    "created_at": "2026-01-10T00:00:00"
  },
  {
    "talker": "技术群2",
    "template_id": "tech_base",
    "llm_type": null,
    "priority": 0,
    "created_at": "2026-01-10T00:00:00"
  }
]
```

然后重启 Web Admin。

### 2. 模板版本管理

建议使用 Git 管理模板：
```bash
cd data/templates
git init
git add templates.json mappings.json
git commit -m "Initial templates"
```

### 3. 导出导入

**导出模板**：
```bash
cp data/templates/templates.json ~/my_templates_backup.json
```

**导入模板**：
```bash
cp ~/my_templates_backup.json data/templates/templates.json
```

## 📞 获取帮助

如有问题，请查看：
- Web Admin 日志：`/tmp/web_admin.log`
- 浏览器控制台（F12）
- 项目主文档：`README.md`

---

**祝使用愉快！如有任何建议或问题，欢迎反馈。** 🎉
