# 每周群聊记录批量处理指南

本指南介绍如何使用两个脚本批量处理2025年每一周的群聊记录。

## 步骤 1: 检查每周数据是否存在

首先，检查2025年每一周的原始数据是否存在，并打印出不存在的时间段。

### 使用方法

```bash
python -m rpa_llm.check_weekly_data --talker "川群-2025" --year 2025
```

### 参数说明

- `--talker`: 聊天对象（必填），如 "川群-2025"
- `--year`: 年份（默认: 2025）
- `--chatlog-url`: chatlog 服务地址（默认: http://127.0.0.1:5030）
- `--config`: 配置文件路径（默认: chatlog_automation.yaml）

### 输出示例

```
[2026-01-03T08:30:00+08:00] [check] 开始检查 2025 年所有周的数据
[2026-01-03T08:30:00+08:00] [check] talker=川群-2025
================================================================================
[2026-01-03T08:30:01+08:00] [check] ✓ 第 1周 (2025-01-06 ~ 2025-01-12): 1 条消息
[2026-01-03T08:30:01+08:00] [check] ✗ 第 2周 (2025-01-13 ~ 2025-01-19): 无数据
...
================================================================================

[check] 检查完成！
[check] 总计: 52 周
[check] 有数据: 45 周
[check] 无数据: 7 周

[check] ⚠️  以下周次缺少数据，请检查微信聊天记录同步:
  - 第 2周: 2025-01-13 ~ 2025-01-19
  - 第 5周: 2025-02-03 ~ 2025-02-09
  ...
```

### 下一步

如果发现有周次缺少数据，请：
1. 在 MacBook 的微信中同步聊天记录
2. 确保 chatlog 服务能够访问到这些数据
3. 重新运行检查脚本确认数据已同步

## 步骤 2: 批量执行每周分析

确认数据完整后，针对每一周的数据执行 GPT 5.2 Pro 的分析。

### 使用方法

```bash
python -m rpa_llm.batch_weekly_analysis --talker "川群-2025" --year 2025 --model-version 5.2pro
```

### 参数说明

- `--talker`: 聊天对象（必填），如 "川群-2025"
- `--year`: 年份（默认: 2025）
- `--model-version`: 模型版本（默认: 5.2pro）
- `--task-timeout-s`: 任务超时时间（秒，默认: 1200，即20分钟）
- `--new-chat`: 每次提交都打开新聊天窗口（默认: False）
- `--no-skip-existing`: 不跳过已存在的 summary 文件（默认会跳过）
- `--no-skip-missing`: 不跳过没有数据的周（默认会跳过）
- `--config`: 配置文件路径（默认: chatlog_automation.yaml）

### 功能特性

1. **自动检查数据**: 先检查所有周的数据情况，只分析有数据的周
2. **跳过已存在**: 默认跳过已存在的 summary 文件，避免重复分析
3. **跳过无数据**: 默认跳过没有数据的周，避免错误
4. **错误处理**: 记录失败的周次和错误信息
5. **进度显示**: 实时显示分析进度和结果

### 输出示例

```
[2026-01-03T08:30:00+08:00] [batch] 开始批量分析 2025 年所有周的数据
[2026-01-03T08:30:00+08:00] [batch] talker=川群-2025
[2026-01-03T08:30:00+08:00] [batch] model_version=5.2pro
[2026-01-03T08:30:00+08:00] [batch] task_timeout_s=1200
================================================================================

[2026-01-03T08:30:01+08:00] [batch] 正在检查所有周的数据情况...
[2026-01-03T08:30:05+08:00] [batch] 跳过第 2周（无数据）
...

[2026-01-03T08:30:10+08:00] [batch] 检查完成:
[2026-01-03T08:30:10+08:00] [batch]   有数据: 45 周
[2026-01-03T08:30:10+08:00] [batch]   无数据: 7 周

[2026-01-03T08:30:10+08:00] [batch] ================================================================================
[2026-01-03T08:30:10+08:00] [batch] 开始分析第 1周 (2025-01-06~2025-01-12)
[2026-01-03T08:30:10+08:00] [automation] 开始自动化流程 (request_id=abc12345)
...
[2026-01-03T08:35:20+08:00] [batch] ✓ 第 1周分析完成

...

================================================================================
[2026-01-03T10:30:00+08:00] [batch] 批量分析完成！
[2026-01-03T10:30:00+08:00] [batch] 总计: 45 周
[2026-01-03T10:30:00+08:00] [batch] 成功: 43 周
[2026-01-03T10:30:00+08:00] [batch] 失败: 2 周
[2026-01-03T10:30:00+08:00] [batch] 跳过: 0 周

[2026-01-03T10:30:00+08:00] [batch] 失败的周次:
  - 第 10周 (2025-03-03~2025-03-09): LLM 分析失败 (site=chatgpt): TimeoutError
  - 第 25周 (2025-06-16~2025-06-22): LLM 分析失败 (site=chatgpt): HTTPError 502
```

## 配置文件

两个脚本都支持从 `chatlog_automation.yaml` 读取配置。配置文件格式：

```yaml
# Chatlog 服务配置
chatlog:
  url: "http://127.0.0.1:5030"

# LLM 分析配置
llm:
  arbitrator_site: "chatgpt"
  model_version: "5.2pro"
  task_timeout_s: 1200
  new_chat: true

# Obsidian 路径配置
obsidian:
  base_path: "~/work/personal/obsidian/personal/10_Sources/WeChat"
  template: "./templates/chatlog_for_wechat.md"

# Driver Server 配置
driver:
  url: null  # 默认从 brief.yaml 读取
```

## 注意事项

1. **确保 driver_server 运行**: 批量分析需要 driver_server 服务运行
2. **超时时间**: GPT 5.2 Pro 分析可能需要较长时间，建议设置 `--task-timeout-s 1200`（20分钟）或更长
3. **新聊天窗口**: 如果使用 `--new-chat`，每次分析都会打开新窗口，可能较慢但更稳定
4. **跳过已存在**: 默认会跳过已存在的 summary 文件，如需重新分析，请先删除文件或使用 `--no-skip-existing`
5. **错误处理**: 如果某些周分析失败，可以单独重新运行这些周的分析

## 单独分析某一周

如果需要单独分析某一周，可以使用原有的 `chatlog_automation` 脚本：

```bash
python -m rpa_llm.chatlog_automation \
  --talker "川群-2025" \
  --start 2025-01-06 \
  --end 2025-01-12 \
  --model_version 5.2pro
```

