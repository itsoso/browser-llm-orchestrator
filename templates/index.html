<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser LLM Orchestrator - ç®¡ç†ç•Œé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background-color: #10b981; }
        .status-stopped { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        
        .log-container {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
        }
        
        .tab-button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab-button:hover {
            color: #3b82f6;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            ring: 2px;
            ring-color: #3b82f650;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">ğŸ¤– Browser LLM Orchestrator</h1>
                        <p class="text-sm text-gray-600 mt-1">å¤š LLM å†³ç­–ç³»ç»Ÿ Web ç®¡ç†ç•Œé¢</p>
                    </div>
                    <div>
                        <button onclick="refreshStatus()" class="btn btn-primary">
                            ğŸ”„ åˆ·æ–°çŠ¶æ€
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-6 py-8">
            <!-- Status Card -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="flex items-center mb-2">
                            <span id="driver-status-dot" class="status-dot status-stopped"></span>
                            <span class="font-medium">Driver Server</span>
                        </div>
                        <div class="text-sm text-gray-600" id="driver-info">æ£€æŸ¥ä¸­...</div>
                        <div class="mt-3 flex gap-2">
                            <button onclick="startDriver()" id="btn-start-driver" class="btn btn-success text-sm">
                                â–¶ï¸ å¯åŠ¨
                            </button>
                            <button onclick="stopDriver()" id="btn-stop-driver" class="btn btn-danger text-sm">
                                â¹ï¸ åœæ­¢
                            </button>
                        </div>
                    </div>
                    <div>
                        <div class="font-medium mb-2">âš™ï¸ é…ç½®ä¿¡æ¯</div>
                        <div class="text-sm text-gray-600">
                            <div>ç«™ç‚¹: <span id="config-sites">-</span></div>
                            <div>è¾“å‡ºç›®å½•: <span id="config-output">-</span></div>
                            <div>æœ€åæ›´æ–°: <span id="status-timestamp">-</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="card">
                <div class="border-b border-gray-200 mb-6">
                    <div class="flex">
                        <button class="tab-button active" onclick="showTab('warmup')">
                            ğŸ”¥ ç«™ç‚¹é¢„çƒ­
                        </button>
                        <button class="tab-button" onclick="showTab('chatlog')">
                            ğŸ’¬ Chatlog è‡ªåŠ¨åŒ–
                        </button>
                        <button class="tab-button" onclick="showTab('logs')">
                            ğŸ“ æ—¥å¿—æŸ¥çœ‹
                        </button>
                        <button class="tab-button" onclick="showTab('config')">
                            âš™ï¸ é…ç½®ç®¡ç†
                        </button>
                    </div>
                </div>

                <!-- Warmup Tab -->
                <div id="tab-warmup" class="tab-content">
                    <h3 class="text-lg font-semibold mb-4">ç«™ç‚¹é¢„çƒ­ï¼ˆé¦–æ¬¡ç™»å½•ï¼‰</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        é¦–æ¬¡ä½¿ç”¨å‰ï¼Œéœ€è¦é¢„çƒ­å„ä¸ªç«™ç‚¹å¹¶æ‰‹åŠ¨ç™»å½•ä¿å­˜ Sessionã€‚
                    </p>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <button onclick="warmupSite('chatgpt')" class="btn btn-primary">
                            ChatGPT
                        </button>
                        <button onclick="warmupSite('gemini')" class="btn btn-primary">
                            Gemini
                        </button>
                        <button onclick="warmupSite('grok')" class="btn btn-primary">
                            Grok
                        </button>
                        <button onclick="warmupSite('perplexity')" class="btn btn-primary">
                            Perplexity
                        </button>
                        <button onclick="warmupSite('qianwen')" class="btn btn-primary">
                            é€šä¹‰åƒé—®
                        </button>
                    </div>
                    <div id="warmup-output" class="mt-6 log-container hidden"></div>
                </div>

                <!-- Chatlog Tab -->
                <div id="tab-chatlog" class="tab-content hidden">
                    <h3 class="text-lg font-semibold mb-4">Chatlog ç¾¤èŠè‡ªåŠ¨åŒ–åˆ†æ</h3>
                    <form onsubmit="runChatlog(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ç¾¤èŠæ ‡è¯† *
                                </label>
                                <input type="text" id="chatlog-talker" class="input-field" 
                                       placeholder="ä¾‹å¦‚: xxç¾¤-2025" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    å¼€å§‹æ—¥æœŸ *
                                </label>
                                <input type="date" id="chatlog-start" class="input-field" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ç»“æŸæ—¥æœŸ *
                                </label>
                                <input type="date" id="chatlog-end" class="input-field" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    æ¨¡å‹ç‰ˆæœ¬
                                </label>
                                <select id="chatlog-model" class="input-field">
                                    <option value="5.2pro">ChatGPT 5.2 Proï¼ˆæ·±åº¦æ¨ç†ï¼Œ20-30åˆ†é’Ÿï¼‰</option>
                                    <option value="5.2thinking">ChatGPT 5.2 Thinkingï¼ˆå¹³è¡¡æ¨¡å¼ï¼‰</option>
                                    <option value="5.2instant">ChatGPT 5.2 Instantï¼ˆå¿«é€Ÿå“åº”ï¼‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    æ¨¡æ¿è·¯å¾„ï¼ˆå¯é€‰ï¼‰
                                </label>
                                <input type="text" id="chatlog-template" class="input-field" 
                                       placeholder="é»˜è®¤ä½¿ç”¨ templates/chatlog_for_wechat.md">
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="chatlog-newchat" checked class="mr-2">
                            <label for="chatlog-newchat" class="text-sm text-gray-700">
                                æ¯æ¬¡æ‰“å¼€æ–°å¯¹è¯çª—å£
                            </label>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-success">
                                ğŸš€ å¼€å§‹åˆ†æ
                            </button>
                        </div>
                    </form>
                    <div id="chatlog-result" class="mt-6 hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-green-800">âœ… Chatlog è‡ªåŠ¨åŒ–å·²å¯åŠ¨</p>
                            <p class="text-sm text-green-700 mt-1">
                                æ—¥å¿—æ–‡ä»¶: <span id="chatlog-logfile"></span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div id="tab-logs" class="tab-content hidden">
                    <h3 class="text-lg font-semibold mb-4">æ—¥å¿—æŸ¥çœ‹</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æ—¥å¿—ç±»å‹
                        </label>
                        <select id="log-type" onchange="loadLogs()" class="input-field">
                            <option value="driver">Driver Server</option>
                            <option value="chatlog_automation">Chatlog è‡ªåŠ¨åŒ–</option>
                            <option value="chatlog_web">Web è§¦å‘çš„ Chatlog</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æœ€è¿‘çš„æ—¥å¿—æ–‡ä»¶
                        </label>
                        <select id="log-files" onchange="viewLog()" class="input-field">
                            <option value="">-- é€‰æ‹©æ—¥å¿—æ–‡ä»¶ --</option>
                        </select>
                    </div>
                    <div id="log-content" class="log-container"></div>
                </div>

                <!-- Config Tab -->
                <div id="tab-config" class="tab-content hidden">
                    <h3 class="text-lg font-semibold mb-4">é…ç½®ç®¡ç†</h3>
                    <div class="space-y-6">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium">brief.yaml</h4>
                                <button onclick="loadConfigBrief()" class="text-sm text-blue-600 hover:text-blue-700">
                                    ğŸ”„ åˆ·æ–°
                                </button>
                            </div>
                            <pre id="config-brief" class="log-container">åŠ è½½ä¸­...</pre>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium">chatlog_automation.yaml</h4>
                                <button onclick="loadConfigChatlog()" class="text-sm text-blue-600 hover:text-blue-700">
                                    ğŸ”„ åˆ·æ–°
                                </button>
                            </div>
                            <pre id="config-chatlog" class="log-container">åŠ è½½ä¸­...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let currentTab = 'warmup';
        let statusRefreshInterval = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
            loadLogs();
            loadConfigBrief();
            loadConfigChatlog();
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæ˜¨å¤©åˆ°ä»Šå¤©ï¼‰
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            document.getElementById('chatlog-end').value = today.toISOString().split('T')[0];
            document.getElementById('chatlog-start').value = yesterday.toISOString().split('T')[0];
            
            // è‡ªåŠ¨åˆ·æ–°çŠ¶æ€ï¼ˆæ¯ 5 ç§’ï¼‰
            statusRefreshInterval = setInterval(refreshStatus, 5000);
        });

        // Tab åˆ‡æ¢
        function showTab(tabName) {
            currentTab = tabName;
            
            // éšè—æ‰€æœ‰ tab
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('active');
            });
            
            // æ˜¾ç¤ºå½“å‰ tab
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            event.target.classList.add('active');
        }

        // åˆ·æ–°çŠ¶æ€
        async function refreshStatus() {
            try {
                const response = await axios.get('/api/status');
                const data = response.data;
                
                // æ›´æ–° Driver Server çŠ¶æ€
                const driver = data.driver;
                const statusDot = document.getElementById('driver-status-dot');
                const driverInfo = document.getElementById('driver-info');
                
                if (driver.running && driver.ok) {
                    statusDot.className = 'status-dot status-running';
                    driverInfo.innerHTML = `
                        è¿è¡Œä¸­ âœ…<br>
                        <span class="text-xs">ç«™ç‚¹: ${driver.sites.join(', ')}</span><br>
                        <span class="text-xs">URL: ${driver.url}</span>
                    `;
                    document.getElementById('btn-start-driver').disabled = true;
                    document.getElementById('btn-stop-driver').disabled = false;
                } else {
                    statusDot.className = 'status-dot status-stopped';
                    driverInfo.innerHTML = `æœªè¿è¡Œ âŒ<br><span class="text-xs">${driver.error || 'æœªå¯åŠ¨'}</span>`;
                    document.getElementById('btn-start-driver').disabled = false;
                    document.getElementById('btn-stop-driver').disabled = true;
                }
                
                // æ›´æ–°é…ç½®ä¿¡æ¯
                document.getElementById('config-sites').textContent = data.brief.sites.join(', ') || '-';
                document.getElementById('config-output').textContent = data.brief.output_dir || '-';
                document.getElementById('status-timestamp').textContent = new Date(data.timestamp).toLocaleString('zh-CN');
                
            } catch (error) {
                console.error('åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // å¯åŠ¨ Driver Server
        async function startDriver() {
            try {
                document.getElementById('btn-start-driver').disabled = true;
                document.getElementById('btn-start-driver').textContent = 'â³ å¯åŠ¨ä¸­...';
                
                const response = await axios.post('/api/driver/start');
                
                if (response.data.ok) {
                    alert('âœ… Driver Server å·²å¯åŠ¨ï¼\nPID: ' + response.data.pid);
                    await refreshStatus();
                } else {
                    alert('âŒ å¯åŠ¨å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                alert('âŒ å¯åŠ¨å¤±è´¥: ' + (error.response?.data?.error || error.message));
            } finally {
                document.getElementById('btn-start-driver').textContent = 'â–¶ï¸ å¯åŠ¨';
                await refreshStatus();
            }
        }

        // åœæ­¢ Driver Server
        async function stopDriver() {
            if (!confirm('ç¡®å®šè¦åœæ­¢ Driver Server å—ï¼Ÿ')) {
                return;
            }
            
            try {
                document.getElementById('btn-stop-driver').disabled = true;
                document.getElementById('btn-stop-driver').textContent = 'â³ åœæ­¢ä¸­...';
                
                const response = await axios.post('/api/driver/stop');
                
                if (response.data.ok) {
                    alert('âœ… Driver Server å·²åœæ­¢ï¼');
                    await refreshStatus();
                } else {
                    alert('âŒ åœæ­¢å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                alert('âŒ åœæ­¢å¤±è´¥: ' + (error.response?.data?.error || error.message));
            } finally {
                document.getElementById('btn-stop-driver').textContent = 'â¹ï¸ åœæ­¢';
                await refreshStatus();
            }
        }

        // é¢„çƒ­ç«™ç‚¹
        async function warmupSite(site) {
            const outputDiv = document.getElementById('warmup-output');
            outputDiv.classList.remove('hidden');
            outputDiv.textContent = `ğŸ”¥ æ­£åœ¨é¢„çƒ­ ${site}...\nè¯·åœ¨æ‰“å¼€çš„æµè§ˆå™¨çª—å£ä¸­æ‰‹åŠ¨ç™»å½•...\n`;
            
            try {
                const response = await axios.post(`/api/warmup/${site}`);
                
                if (response.data.ok) {
                    outputDiv.textContent += `\nâœ… ${site} é¢„çƒ­æˆåŠŸï¼\n\n`;
                    outputDiv.textContent += response.data.stdout;
                } else {
                    outputDiv.textContent += `\nâŒ ${site} é¢„çƒ­å¤±è´¥ï¼\n\n`;
                    outputDiv.textContent += response.data.stderr || response.data.error;
                }
            } catch (error) {
                outputDiv.textContent += `\nâŒ è¯·æ±‚å¤±è´¥: ${error.message}\n`;
            }
        }

        // è¿è¡Œ Chatlog è‡ªåŠ¨åŒ–
        async function runChatlog(event) {
            event.preventDefault();
            
            const talker = document.getElementById('chatlog-talker').value;
            const start = document.getElementById('chatlog-start').value;
            const end = document.getElementById('chatlog-end').value;
            const model = document.getElementById('chatlog-model').value;
            const template = document.getElementById('chatlog-template').value;
            const newChat = document.getElementById('chatlog-newchat').checked;
            
            try {
                const response = await axios.post('/api/chatlog/run', {
                    talker, start, end,
                    model_version: model,
                    template: template || null,
                    new_chat: newChat
                });
                
                if (response.data.ok) {
                    document.getElementById('chatlog-result').classList.remove('hidden');
                    document.getElementById('chatlog-logfile').textContent = response.data.log_file;
                    
                    // 3ç§’åè‡ªåŠ¨åˆ‡æ¢åˆ°æ—¥å¿—tab
                    setTimeout(() => {
                        showTab('logs');
                        document.getElementById('log-type').value = 'chatlog_web';
                        loadLogs();
                    }, 3000);
                } else {
                    alert('âŒ å¯åŠ¨å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + (error.response?.data?.error || error.message));
            }
        }

        // åŠ è½½æ—¥å¿—åˆ—è¡¨
        async function loadLogs() {
            const logType = document.getElementById('log-type').value;
            const select = document.getElementById('log-files');
            
            try {
                const response = await axios.get(`/api/logs/${logType}`);
                
                if (response.data.ok) {
                    select.innerHTML = '<option value="">-- é€‰æ‹©æ—¥å¿—æ–‡ä»¶ --</option>';
                    response.data.logs.forEach(log => {
                        const option = document.createElement('option');
                        option.value = log.name;
                        option.textContent = `${log.name} (${log.modified}, ${(log.size / 1024).toFixed(1)} KB)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æŸ¥çœ‹æ—¥å¿—
        async function viewLog() {
            const filename = document.getElementById('log-files').value;
            if (!filename) return;
            
            const contentDiv = document.getElementById('log-content');
            contentDiv.textContent = 'åŠ è½½ä¸­...';
            
            try {
                const response = await axios.get(`/api/logs/view/${filename}`);
                
                if (response.data.ok) {
                    contentDiv.textContent = response.data.content;
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    contentDiv.scrollTop = contentDiv.scrollHeight;
                } else {
                    contentDiv.textContent = 'âŒ åŠ è½½å¤±è´¥: ' + response.data.error;
                }
            } catch (error) {
                contentDiv.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfigBrief() {
            const pre = document.getElementById('config-brief');
            pre.textContent = 'åŠ è½½ä¸­...';
            
            try {
                const response = await axios.get('/api/config/brief');
                if (response.data.ok) {
                    pre.textContent = JSON.stringify(response.data.config, null, 2);
                } else {
                    pre.textContent = 'âŒ åŠ è½½å¤±è´¥: ' + response.data.error;
                }
            } catch (error) {
                pre.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
            }
        }

        async function loadConfigChatlog() {
            const pre = document.getElementById('config-chatlog');
            pre.textContent = 'åŠ è½½ä¸­...';
            
            try {
                const response = await axios.get('/api/config/chatlog');
                if (response.data.ok) {
                    pre.textContent = JSON.stringify(response.data.config, null, 2);
                } else {
                    pre.textContent = 'âŒ åŠ è½½å¤±è´¥: ' + response.data.error;
                }
            } catch (error) {
                pre.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
            }
        }
    </script>
</body>
</html>

