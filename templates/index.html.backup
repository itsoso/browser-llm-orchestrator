<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser LLM Orchestrator - ç®¡ç†ç•Œé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background-color: #10b981; }
        .status-stopped { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        
        .log-container {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* å·¦ä¾§èœå•æ ·å¼ */
        .sidebar {
            width: 240px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: linear-gradient(180deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .menu-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-left-color: white;
        }
        
        .menu-item-icon {
            margin-right: 12px;
            font-size: 18px;
        }
        
        .main-content {
            margin-left: 240px;
            min-height: 100vh;
            padding: 20px;
        }
        
        .status-bar {
            background: white;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            ring: 2px;
            ring-color: #3b82f650;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- å·¦ä¾§èœå• -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1 class="text-xl font-bold">ğŸ¤– LLM Orchestrator</h1>
            <p class="text-xs text-blue-200 mt-1">å¤š LLM å†³ç­–ç³»ç»Ÿ</p>
        </div>
        
        <nav class="mt-4">
            <div class="menu-item active" onclick="showTab('warmup')">
                <span class="menu-item-icon">ğŸ”¥</span>
                <span>ç«™ç‚¹é¢„çƒ­</span>
            </div>
            <div class="menu-item" onclick="showTab('chatlog')">
                <span class="menu-item-icon">ğŸ’¬</span>
                <span>Chatlog è‡ªåŠ¨åŒ–</span>
            </div>
            <div class="menu-item" onclick="showTab('recap')">
                <span class="menu-item-icon">ğŸ“Š</span>
                <span>æ¯æ—¥å¤ç›˜</span>
            </div>
            <div class="menu-item" onclick="showTab('logs')">
                <span class="menu-item-icon">ğŸ“</span>
                <span>æ—¥å¿—æŸ¥çœ‹</span>
            </div>
            <div class="menu-item" onclick="showTab('config')">
                <span class="menu-item-icon">âš™ï¸</span>
                <span>é…ç½®ç®¡ç†</span>
            </div>
            <div class="menu-item" onclick="showTab('templates')">
                <span class="menu-item-icon">ğŸ¨</span>
                <span>æ¨¡æ¿ç®¡ç†</span>
            </div>
        </nav>
    </aside>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="flex items-center space-x-6">
                <div class="flex items-center">
                    <span id="driver-status-dot" class="status-dot status-stopped"></span>
                    <span class="text-sm font-medium">Driver Server</span>
                    <span id="driver-status-text" class="ml-2 text-sm text-gray-600">æ£€æŸ¥ä¸­...</span>
                </div>
                <div class="text-sm text-gray-600">
                    <span id="driver-config-sites">ç«™ç‚¹: -</span>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="startDriver()" id="start-driver-btn" class="text-sm px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">
                    â–¶ï¸ å¯åŠ¨
                </button>
                <button onclick="stopDriver()" id="stop-driver-btn" class="text-sm px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">
                    â¹ åœæ­¢
                </button>
                <button onclick="refreshStatus()" class="text-sm px-3 py-1 text-blue-600 hover:text-blue-700">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- åŸæœ‰å†…å®¹åŒºåŸŸ -->
        <div class="bg-white rounded-lg shadow p-6">
                <!-- Warmup Tab -->
                <div id="tab-warmup" class="tab-content">
                    <h3 class="text-lg font-semibold mb-4">ç«™ç‚¹é¢„çƒ­ï¼ˆé¦–æ¬¡ç™»å½•ï¼‰</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        é¦–æ¬¡ä½¿ç”¨å‰ï¼Œéœ€è¦é¢„çƒ­å„ä¸ªç«™ç‚¹å¹¶æ‰‹åŠ¨ç™»å½•ä¿å­˜ Sessionã€‚
                    </p>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <button onclick="warmupSite('chatgpt')" class="btn btn-primary">
                            ChatGPT
                        </button>
                        <button onclick="warmupSite('gemini')" class="btn btn-primary">
                            Gemini
                        </button>
                        <button onclick="warmupSite('grok')" class="btn btn-primary">
                            Grok
                        </button>
                        <button onclick="warmupSite('perplexity')" class="btn btn-primary">
                            Perplexity
                        </button>
                        <button onclick="warmupSite('qianwen')" class="btn btn-primary">
                            é€šä¹‰åƒé—®
                        </button>
                    </div>
                    <div id="warmup-output" class="mt-6 log-container hidden"></div>
                </div>

                <!-- Chatlog Tab -->
                <div id="tab-chatlog" class="tab-content hidden">
                    <h3 class="text-lg font-semibold mb-4">Chatlog ç¾¤èŠè‡ªåŠ¨åŒ–åˆ†æ</h3>
                    <form onsubmit="runChatlog(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ç¾¤èŠæ ‡è¯† *
                                </label>
                                <input type="text" id="chatlog-talker" class="input-field" 
                                       placeholder="ä¾‹å¦‚: xxç¾¤-2025" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    å¼€å§‹æ—¥æœŸ *
                                </label>
                                <input type="date" id="chatlog-start" class="input-field" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ç»“æŸæ—¥æœŸ *
                                </label>
                                <input type="date" id="chatlog-end" class="input-field" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    æ¨¡å‹ç‰ˆæœ¬
                                </label>
                                <select id="chatlog-model" class="input-field">
                                    <option value="5.2pro">ChatGPT 5.2 Proï¼ˆæ·±åº¦æ¨ç†ï¼Œ20-30åˆ†é’Ÿï¼‰</option>
                                    <option value="5.2thinking">ChatGPT 5.2 Thinkingï¼ˆå¹³è¡¡æ¨¡å¼ï¼‰</option>
                                    <option value="5.2instant">ChatGPT 5.2 Instantï¼ˆå¿«é€Ÿå“åº”ï¼‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    æ¨¡æ¿è·¯å¾„ï¼ˆå¯é€‰ï¼‰
                                </label>
                                <input type="text" id="chatlog-template" class="input-field" 
                                       placeholder="é»˜è®¤ä½¿ç”¨ templates/chatlog_for_wechat.md">
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="chatlog-newchat" checked class="mr-2">
                            <label for="chatlog-newchat" class="text-sm text-gray-700">
                                æ¯æ¬¡æ‰“å¼€æ–°å¯¹è¯çª—å£
                            </label>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-success">
                                ğŸš€ å¼€å§‹åˆ†æ
                            </button>
                        </div>
                    </form>
                    <div id="chatlog-result" class="mt-6 hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-green-800">âœ… Chatlog è‡ªåŠ¨åŒ–å·²å¯åŠ¨</p>
                            <p class="text-sm text-green-700 mt-1">
                                æ—¥å¿—æ–‡ä»¶: <span id="chatlog-logfile"></span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Daily Recap Tab -->
                <div id="tab-recap" class="tab-content hidden">
                    <h3 class="text-lg font-semibold mb-4">ğŸ“Š æ¯æ—¥ç¾¤èŠå¤ç›˜</h3>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <!-- å·¦ä¾§ï¼šåˆ›å»ºæ–°æ‰¹æ¬¡ -->
                        <div class="card">
                            <h4 class="text-md font-semibold mb-4">åˆ›å»ºå¤ç›˜ä»»åŠ¡</h4>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    æ—¥æœŸèŒƒå›´
                                </label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">å¼€å§‹æ—¥æœŸ</label>
                                        <input type="date" id="recap-date-start" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">ç»“æŸæ—¥æœŸ</label>
                                        <input type="date" id="recap-date-end" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">ğŸ’¡ æç¤ºï¼šé€‰æ‹©ç›¸åŒæ—¥æœŸå¯åˆ†æå•å¤©</p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    LLM ç«™ç‚¹ï¼ˆå¯å¤šé€‰ï¼‰
                                </label>
                                <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
                                    <label class="flex items-center cursor-pointer hover:bg-gray-100 p-1 rounded">
                                        <input type="checkbox" id="llm-chatgpt" value="chatgpt" class="mr-2" checked>
                                        <span class="text-sm">ChatGPT âš¡</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer hover:bg-gray-100 p-1 rounded">
                                        <input type="checkbox" id="llm-gemini" value="gemini" class="mr-2">
                                        <span class="text-sm">Gemini</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer hover:bg-gray-100 p-1 rounded">
                                        <input type="checkbox" id="llm-grok" value="grok" class="mr-2">
                                        <span class="text-sm">Grok</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer hover:bg-gray-100 p-1 rounded">
                                        <input type="checkbox" id="llm-perplexity" value="perplexity" class="mr-2">
                                        <span class="text-sm">Perplexity</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer hover:bg-gray-100 p-1 rounded">
                                        <input type="checkbox" id="llm-qianwen" value="qianwen" class="mr-2">
                                        <span class="text-sm">é€šä¹‰åƒé—®</span>
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">ğŸ’¡ é€‰æ‹©å¤šä¸ª LLM å¯ä»¥å¯¹æ¯”åˆ†æç»“æœ</p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    æ¨¡å‹ç‰ˆæœ¬
                                </label>
                                <select id="recap-model" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="5.2instant">ChatGPT 5.2 Instant (å¿«é€Ÿ)</option>
                                    <option value="5.2thinking">ChatGPT 5.2 Thinking (æ·±åº¦æ€è€ƒ)</option>
                                    <option value="5.2pro">ChatGPT 5.2 Pro (æœ€ä½³è´¨é‡)</option>
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Prompt æ¨¡æ¿
                                </label>
                                <select id="recap-template" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">-- ä½¿ç”¨é»˜è®¤æ¨¡æ¿ --</option>
                                    <!-- åŠ¨æ€åŠ è½½æ¨¡æ¿åˆ—è¡¨ -->
                                </select>
                                <p class="text-xs text-gray-500 mt-1">ğŸ’¡ å¯åœ¨"æ¨¡æ¿ç®¡ç†"ä¸­åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ¿</p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="recap-public" class="mr-2">
                                    <span class="text-sm text-gray-700">å…¬å¼€åˆ†äº«ï¼ˆå¯åœ¨å°ç¨‹åºä¸­æŸ¥çœ‹ï¼‰</span>
                                </label>
                            </div>
                            
                            <button onclick="loadTalkers()" class="btn btn-primary w-full mb-4">
                                åŠ è½½ç¾¤èŠåˆ—è¡¨
                            </button>
                            
                            <div id="talkers-container" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    é€‰æ‹©ç¾¤èŠï¼ˆæœ€è¿‘ 7 å¤©æœ‰å¯¹è¯ï¼‰
                                </label>
                                <div id="talkers-list" class="max-h-48 overflow-y-auto border border-gray-300 rounded-md p-2">
                                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                                </div>
                                
                                <button onclick="createRecapBatch()" class="btn btn-success w-full mt-4">
                                    åˆ›å»ºæ‰¹æ¬¡å¹¶å¼€å§‹å¤„ç†
                                </button>
                            </div>
                        </div>
                        
                        <!-- è¿›åº¦ç›‘æ§åŒºåŸŸï¼ˆç‹¬ç«‹æ˜¾ç¤ºï¼Œä¸å— talkers-container å½±å“ï¼‰-->
                        <div class="card mt-4">
                            <div id="progress-monitor" class="hidden p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-semibold text-blue-900">â³ å¤„ç†è¿›åº¦</h5>
                                    <button onclick="hideProgressMonitor()" class="text-blue-600 hover:text-blue-800 text-sm">
                                        å…³é—­
                                    </button>
                                </div>
                                <div id="progress-content" class="text-sm space-y-2">
                                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šæ‰¹æ¬¡å†å² -->
                        <div class="card">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-md font-semibold">å¤ç›˜å†å²</h4>
                                <div class="flex items-center gap-2">
                                    <label class="flex items-center text-xs text-gray-600 cursor-pointer">
                                        <input type="checkbox" id="auto-refresh-batches" class="mr-1" onchange="toggleAutoRefreshBatches()">
                                        <span>è‡ªåŠ¨åˆ·æ–°</span>
                                    </label>
                                    <span id="refresh-countdown" class="text-xs text-gray-400 hidden">(5s)</span>
                                </div>
                            </div>
                            
                            <button onclick="loadRecapBatches()" class="btn btn-primary w-full mb-4">
                                ğŸ”„ åˆ·æ–°åˆ—è¡¨
                            </button>
                            
                            <div id="recap-batches-list" class="max-h-96 overflow-y-auto">
                                <p class="text-sm text-gray-500">ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"æŸ¥çœ‹å†å²æ‰¹æ¬¡</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ‰¹æ¬¡è¯¦æƒ…å¯¹è¯æ¡† -->
                    <div id="batch-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">æ‰¹æ¬¡è¯¦æƒ…</h3>
                                <button onclick="closeBatchDetail()" class="text-gray-500 hover:text-gray-700">
                                    âœ•
                                </button>
                            </div>
                            <div id="batch-detail-content">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¼€å‘è°ƒè¯•å·¥å…· -->
                    <div class="mt-6 p-3 bg-gray-100 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">ğŸ”§ å¼€å‘è°ƒè¯•</span>
                            <button onclick="showProgressMonitor('test-123'); updateProgressDisplay('test-123', {status: 'pending', message: 'ğŸ§ª æµ‹è¯•è¿›åº¦ç›‘æ§åŠŸèƒ½...'});" class="text-xs px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">
                                ğŸ§ª æµ‹è¯•è¿›åº¦æ˜¾ç¤º
                            </button>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Logs Tab -->
                <div id="tab-logs" class="tab-content hidden">
                    <h3 class="text-lg font-semibold mb-4">æ—¥å¿—æŸ¥çœ‹</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æ—¥å¿—ç±»å‹
                        </label>
                        <select id="log-type" onchange="loadLogs()" class="input-field">
                            <option value="driver">Driver Server</option>
                            <option value="chatlog_automation">Chatlog è‡ªåŠ¨åŒ–</option>
                            <option value="chatlog_web">Web è§¦å‘çš„ Chatlog</option>
                            <option value="web_admin">Web ç®¡ç†ç•Œé¢</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æœ€è¿‘çš„æ—¥å¿—æ–‡ä»¶
                        </label>
                        <select id="log-files" onchange="viewLog()" class="input-field">
                            <option value="">-- é€‰æ‹©æ—¥å¿—æ–‡ä»¶ --</option>
                        </select>
                    </div>
                    <div id="log-content" class="log-container"></div>
                </div>

                <!-- Config Tab -->
                <div id="tab-config" class="tab-content hidden">
                    <h3 class="text-lg font-semibold mb-4">é…ç½®ç®¡ç†</h3>
                    <div class="space-y-6">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium">brief.yaml</h4>
                                <button onclick="loadConfigBrief()" class="text-sm text-blue-600 hover:text-blue-700">
                                    ğŸ”„ åˆ·æ–°
                                </button>
                            </div>
                            <pre id="config-brief" class="log-container">åŠ è½½ä¸­...</pre>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium">chatlog_automation.yaml</h4>
                                <button onclick="loadConfigChatlog()" class="text-sm text-blue-600 hover:text-blue-700">
                                    ğŸ”„ åˆ·æ–°
                                </button>
                            </div>
                            <pre id="config-chatlog" class="log-container">åŠ è½½ä¸­...</pre>
                        </div>
                    </div>
                </div>

                <!-- Templates Tab -->
                <div id="tab-templates" class="tab-content hidden" style="min-height: 600px;">
                    <h3 class="text-lg font-semibold mb-4">ğŸ¨ Prompt æ¨¡æ¿ç®¡ç†</h3>
                    
                    <div class="grid grid-cols-2 gap-6" style="min-height: 500px;">
                        <!-- å·¦ä¾§ï¼šæ¨¡æ¿åˆ—è¡¨ -->
                        <div style="min-height: 400px;">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-medium">æ¨¡æ¿åˆ—è¡¨</h4>
                                <button onclick="showCreateTemplateModal()" class="btn btn-primary text-sm">
                                    â• æ–°å»ºæ¨¡æ¿
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <select id="template-llm-filter" onchange="loadTemplates()" class="input-field">
                                    <option value="">å…¨éƒ¨ LLM</option>
                                    <option value="chatgpt">ChatGPT</option>
                                    <option value="gemini">Gemini</option>
                                    <option value="all">é€šç”¨</option>
                                </select>
                            </div>
                            
                            <div id="templates-list" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- æ¨¡æ¿åˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šæ¨¡æ¿é¢„è§ˆå’Œç¾¤èŠæ˜ å°„ -->
                        <div style="min-height: 400px;">
                            <!-- æ¨¡æ¿å†…å®¹é¢„è§ˆ -->
                            <div id="template-preview" class="mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-medium">ğŸ“„ æ¨¡æ¿å†…å®¹é¢„è§ˆ</h4>
                                    <div class="flex items-center gap-2">
                                        <button id="copy-template-btn" onclick="copyTemplateContent()" class="text-blue-600 hover:text-blue-800 text-sm hidden" title="å¤åˆ¶æ¨¡æ¿å†…å®¹">
                                            ğŸ“‹ å¤åˆ¶
                                        </button>
                                        <button id="close-preview-btn" onclick="closeTemplatePreview()" class="text-gray-500 hover:text-gray-700 hidden">
                                            âœ• å…³é—­
                                        </button>
                                    </div>
                                </div>
                                <div id="template-preview-content" class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-sm" style="max-height: 300px; overflow-y: auto;">
                                    <p class="text-gray-500 italic">ç‚¹å‡»å·¦ä¾§æ¨¡æ¿æŸ¥çœ‹å†…å®¹</p>
                                </div>
                            </div>
                            
                            <!-- ç¾¤èŠ-æ¨¡æ¿æ˜ å°„ -->
                            <div>
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-medium">ç¾¤èŠ-æ¨¡æ¿æ˜ å°„</h4>
                                    <button onclick="showCreateMappingModal()" class="btn btn-primary text-sm">
                                        â• æ–°å»ºæ˜ å°„
                                    </button>
                                </div>
                                
                                <div id="mappings-list" class="space-y-2 max-h-48 overflow-y-auto">
                                    <!-- æ˜ å°„åˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€åŠ è½½ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- æ¨¡æ¿åˆ›å»º/ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold" id="template-modal-title">åˆ›å»ºæ¨¡æ¿</h3>
                    <button onclick="hideTemplateModal()" class="text-gray-500 hover:text-gray-700">
                        âœ•
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡æ¿ ID *</label>
                        <input type="text" id="template-id" class="input-field" placeholder="ä¾‹å¦‚: my_custom_template">
                        <p class="text-xs text-gray-500 mt-1">å”¯ä¸€æ ‡è¯†ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡æ¿åç§° *</label>
                        <input type="text" id="template-name" class="input-field" placeholder="ä¾‹å¦‚: è¯»ä¹¦ä¼šç¾¤èŠåˆ†æ">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æè¿°</label>
                        <textarea id="template-description" class="input-field" rows="2" placeholder="ç®€è¦è¯´æ˜è¯¥æ¨¡æ¿çš„ç”¨é€”"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">LLM ç±»å‹</label>
                            <select id="template-llm-type" class="input-field">
                                <option value="all">é€šç”¨</option>
                                <option value="chatgpt">ChatGPT</option>
                                <option value="gemini">Gemini</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åŸºç¡€æ¨¡æ¿</label>
                            <select id="template-base" class="input-field">
                                <option value="">æ— ï¼ˆç‹¬ç«‹æ¨¡æ¿ï¼‰</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">é€‰æ‹©åå°†ç»§æ‰¿åŸºç¡€æ¨¡æ¿çš„å†…å®¹</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡æ¿å†…å®¹ *</label>
                        <textarea id="template-content" class="input-field font-mono text-sm" rows="15" placeholder="è¾“å…¥ Prompt æ¨¡æ¿å†…å®¹ï¼ˆæ”¯æŒ Markdownï¼‰&#10;&#10;å¯ç”¨å˜é‡ï¼š&#10;  {{talker}} - ç¾¤èŠåç§°&#10;  {{date_range}} - æ—¥æœŸèŒƒå›´&#10;  {{message_count}} - æ¶ˆæ¯æ•°é‡"></textarea>
                        <p class="text-xs text-gray-500 mt-1">å¦‚æœé€‰æ‹©äº†åŸºç¡€æ¨¡æ¿ï¼Œæ­¤å†…å®¹å°†è¿½åŠ åˆ°åŸºç¡€æ¨¡æ¿ä¹‹å</p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="hideTemplateModal()" class="btn">å–æ¶ˆ</button>
                    <button onclick="saveTemplate()" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ˜ å°„åˆ›å»ºæ¨¡æ€æ¡† -->
    <div id="mapping-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold">åˆ›å»ºç¾¤èŠ-æ¨¡æ¿æ˜ å°„</h3>
                    <button onclick="hideMappingModal()" class="text-gray-500 hover:text-gray-700">
                        âœ•
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç¾¤èŠåç§° *</label>
                        <select id="mapping-talker" class="input-field">
                            <option value="">-- é€‰æ‹©ç¾¤èŠ --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡æ¿ *</label>
                        <select id="mapping-template" class="input-field">
                            <option value="">-- é€‰æ‹©æ¨¡æ¿ --</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">LLM ç±»å‹ï¼ˆå¯é€‰ï¼‰</label>
                        <select id="mapping-llm-type" class="input-field">
                            <option value="">ä½¿ç”¨æ¨¡æ¿é»˜è®¤å€¼</option>
                            <option value="chatgpt">ChatGPT</option>
                            <option value="gemini">Gemini</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">å¦‚æœæŒ‡å®šï¼Œå°†è¦†ç›–æ¨¡æ¿çš„ LLM ç±»å‹</p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="hideMappingModal()" class="btn">å–æ¶ˆ</button>
                    <button onclick="saveMapping()" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let currentTab = 'warmup';
        let statusRefreshInterval = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[åˆå§‹åŒ–] é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            try {
                console.log('[åˆå§‹åŒ–] åˆ·æ–°ç³»ç»ŸçŠ¶æ€');
                refreshStatus();
                
                console.log('[åˆå§‹åŒ–] åŠ è½½æ—¥å¿—åˆ—è¡¨');
                loadLogs();
                
                console.log('[åˆå§‹åŒ–] åŠ è½½é…ç½®æ–‡ä»¶');
                loadConfigBrief();
                loadConfigChatlog();
                
                // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæ˜¨å¤©åˆ°ä»Šå¤©ï¼‰
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                const endDateEl = document.getElementById('chatlog-end');
                const startDateEl = document.getElementById('chatlog-start');
                
                if (endDateEl && startDateEl) {
                    endDateEl.value = today.toISOString().split('T')[0];
                    startDateEl.value = yesterday.toISOString().split('T')[0];
                    console.log('[åˆå§‹åŒ–] é»˜è®¤æ—¥æœŸå·²è®¾ç½®');
                } else {
                    console.error('[åˆå§‹åŒ–] æ‰¾ä¸åˆ°æ—¥æœŸè¾“å…¥å…ƒç´ ');
                }
                
                // åŠ è½½æ¯æ—¥å¤ç›˜æ¨¡æ¿åˆ—è¡¨
                loadRecapTemplates();
                console.log('[åˆå§‹åŒ–] æ¨¡æ¿åˆ—è¡¨å·²åŠ è½½');
                
                // è‡ªåŠ¨åˆ·æ–°çŠ¶æ€ï¼ˆæ¯ 5 ç§’ï¼‰
                statusRefreshInterval = setInterval(refreshStatus, 5000);
                console.log('[åˆå§‹åŒ–] åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('[åˆå§‹åŒ–] åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });

        // Tab åˆ‡æ¢
        function showTab(tabName, sourceEvent) {
            currentTab = tabName;
            
            // éšè—æ‰€æœ‰ tab
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€ï¼ˆå·¦ä¾§èœå•ï¼‰
            document.querySelectorAll('.menu-item').forEach(el => {
                el.classList.remove('active');
            });
            
            // æ˜¾ç¤ºå½“å‰ tab
            const tabElement = document.getElementById(`tab-${tabName}`);
            if (tabElement) {
                tabElement.classList.remove('hidden');
            }
            
            // æ¿€æ´»å¯¹åº”çš„èœå•é¡¹
            document.querySelectorAll('.menu-item').forEach(el => {
                const onclick = el.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tabName}'`)) {
                    el.classList.add('active');
                }
            });
            
            // ç‰¹æ®Šå¤„ç†ï¼šåˆ‡æ¢åˆ°æ¨¡æ¿ç®¡ç†æ—¶åŠ è½½æ•°æ®
            if (tabName === 'templates') {
                loadTemplates();
                loadMappings();
            }
        }

        // åˆ·æ–°çŠ¶æ€
        async function refreshStatus() {
            try {
                const response = await axios.get('/api/status');
                const data = response.data;
                
                // æ›´æ–° Driver Server çŠ¶æ€
                const driver = data.driver;
                const statusDot = document.getElementById('driver-status-dot');
                const statusText = document.getElementById('driver-status-text');
                const configSites = document.getElementById('driver-config-sites');
                const startBtn = document.getElementById('start-driver-btn');
                const stopBtn = document.getElementById('stop-driver-btn');
                
                // è·å–ç«™ç‚¹åˆ—è¡¨ï¼ˆä¼˜å…ˆä½¿ç”¨ driver.sitesï¼Œå¦‚æœä¸ºç©ºåˆ™ç”¨ brief.sitesï¼‰
                const sitesList = (driver.sites && driver.sites.length > 0) 
                    ? driver.sites.join(', ') 
                    : (data.brief.sites ? data.brief.sites.join(', ') : '-');
                
                if (driver.running && driver.ok) {
                    if (statusDot) statusDot.className = 'status-dot status-running';
                    if (statusText) statusText.textContent = `è¿è¡Œä¸­ âœ…`;
                    if (configSites) configSites.textContent = `ç«™ç‚¹: ${sitesList}`;
                    if (startBtn) startBtn.disabled = true;
                    if (stopBtn) stopBtn.disabled = false;
                } else {
                    if (statusDot) statusDot.className = 'status-dot status-stopped';
                    if (statusText) statusText.textContent = driver.error || 'å·²åœæ­¢';
                    if (configSites) configSites.textContent = `ç«™ç‚¹: ${sitesList}`;
                    if (startBtn) startBtn.disabled = false;
                    if (stopBtn) stopBtn.disabled = true;
                }
                
            } catch (error) {
                console.error('åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // å¯åŠ¨ Driver Server
        async function startDriver() {
            try {
                document.getElementById('start-driver-btn').disabled = true;
                document.getElementById('start-driver-btn').textContent = 'â³ å¯åŠ¨ä¸­...';
                
                const response = await axios.post('/api/driver/start');
                
                if (response.data.ok) {
                    alert('âœ… Driver Server å·²å¯åŠ¨ï¼\nPID: ' + response.data.pid);
                    await refreshStatus();
                } else {
                    alert('âŒ å¯åŠ¨å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                alert('âŒ å¯åŠ¨å¤±è´¥: ' + (error.response?.data?.error || error.message));
            } finally {
                document.getElementById('start-driver-btn').textContent = 'â–¶ï¸ å¯åŠ¨';
                await refreshStatus();
            }
        }

        // åœæ­¢ Driver Server
        async function stopDriver() {
            const button = document.getElementById('stop-driver-btn');
            if (!button) return;
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºè¿›åº¦
            button.disabled = true;
            button.textContent = 'â³ åœæ­¢ä¸­...';
            button.style.opacity = '0.6';

            try {
                const response = await axios.post('/api/driver/stop');
                
                if (response.data.ok) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    button.textContent = 'âœ… å·²åœæ­¢';
                    button.style.backgroundColor = '#10b981';
                    
                    // 3ç§’åæ¢å¤
                    setTimeout(() => {
                        button.textContent = 'â¹ï¸ åœæ­¢';
                        button.style.backgroundColor = '';
                        button.style.opacity = '1';
                    }, 3000);
                    
                    // åˆ·æ–°çŠ¶æ€
                    await refreshStatus();
                } else {
                    throw new Error(response.data.error || 'åœæ­¢å¤±è´¥');
                }
            } catch (error) {
                console.error('Stop driver error:', error);
                
                // æ˜¾ç¤ºé”™è¯¯
                button.textContent = 'âŒ å¤±è´¥';
                button.style.backgroundColor = '#ef4444';
                alert('âŒ åœæ­¢å¤±è´¥: ' + (error.response?.data?.error || error.message));
                
                // 3ç§’åæ¢å¤
                setTimeout(() => {
                    button.textContent = 'â¹ï¸ åœæ­¢';
                    button.style.backgroundColor = '';
                    button.style.opacity = '1';
                    button.disabled = false;
                }, 3000);
            } finally {
                // ç¡®ä¿åˆ·æ–°çŠ¶æ€
                setTimeout(() => {
                    refreshStatus();
                }, 1000);
            }
        }

        // é¢„çƒ­ç«™ç‚¹
        async function warmupSite(site) {
            const outputDiv = document.getElementById('warmup-output');
            outputDiv.classList.remove('hidden');
            outputDiv.textContent = `ğŸ”¥ æ­£åœ¨é¢„çƒ­ ${site}...\nè¯·åœ¨æ‰“å¼€çš„æµè§ˆå™¨çª—å£ä¸­æ‰‹åŠ¨ç™»å½•...\n`;
            
            try {
                const response = await axios.post(`/api/warmup/${site}`);
                
                if (response.data.ok) {
                    outputDiv.textContent += `\nâœ… ${site} é¢„çƒ­æˆåŠŸï¼\n\n`;
                    outputDiv.textContent += response.data.stdout;
                } else {
                    outputDiv.textContent += `\nâŒ ${site} é¢„çƒ­å¤±è´¥ï¼\n\n`;
                    outputDiv.textContent += response.data.stderr || response.data.error;
                }
            } catch (error) {
                outputDiv.textContent += `\nâŒ è¯·æ±‚å¤±è´¥: ${error.message}\n`;
            }
        }

        // è¿è¡Œ Chatlog è‡ªåŠ¨åŒ–
        async function runChatlog(event) {
            event.preventDefault();
            
            const talker = document.getElementById('chatlog-talker').value;
            const start = document.getElementById('chatlog-start').value;
            const end = document.getElementById('chatlog-end').value;
            const model = document.getElementById('chatlog-model').value;
            const template = document.getElementById('chatlog-template').value;
            const newChat = document.getElementById('chatlog-newchat').checked;
            
            try {
                const response = await axios.post('/api/chatlog/run', {
                    talker, start, end,
                    model_version: model,
                    template: template || null,
                    new_chat: newChat
                });
                
                if (response.data.ok) {
                    document.getElementById('chatlog-result').classList.remove('hidden');
                    document.getElementById('chatlog-logfile').textContent = response.data.log_file;
                    
                    // 3ç§’åè‡ªåŠ¨åˆ‡æ¢åˆ°æ—¥å¿—tab
                    setTimeout(() => {
                        showTab('logs');
                        document.getElementById('log-type').value = 'chatlog_web';
                        loadLogs();
                    }, 3000);
                } else {
                    alert('âŒ å¯åŠ¨å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + (error.response?.data?.error || error.message));
            }
        }

        // åŠ è½½æ—¥å¿—åˆ—è¡¨
        async function loadLogs() {
            console.log('[loadLogs] å¼€å§‹åŠ è½½æ—¥å¿—åˆ—è¡¨');
            const logType = document.getElementById('log-type').value;
            const select = document.getElementById('log-files');
            
            if (!select) {
                console.error('[loadLogs] æ‰¾ä¸åˆ° log-files å…ƒç´ ');
                return;
            }
            
            try {
                console.log('[loadLogs] è¯·æ±‚ API:', `/api/logs/${logType}`);
                const response = await axios.get(`/api/logs/${logType}`);
                console.log('[loadLogs] å“åº”:', response.data);
                
                if (response.data.ok) {
                    select.innerHTML = '<option value="">-- é€‰æ‹©æ—¥å¿—æ–‡ä»¶ --</option>';
                    response.data.logs.forEach(log => {
                        const option = document.createElement('option');
                        option.value = log.name;
                        option.textContent = `${log.name} (${log.modified}, ${(log.size / 1024).toFixed(1)} KB)`;
                        select.appendChild(option);
                    });
                    console.log('[loadLogs] æˆåŠŸåŠ è½½', response.data.logs.length, 'ä¸ªæ—¥å¿—æ–‡ä»¶');
                } else {
                    console.error('[loadLogs] API è¿”å›é”™è¯¯:', response.data.error);
                    select.innerHTML = '<option value="">âŒ åŠ è½½å¤±è´¥</option>';
                }
            } catch (error) {
                console.error('[loadLogs] åŠ è½½æ—¥å¿—åˆ—è¡¨å¤±è´¥:', error);
                select.innerHTML = '<option value="">âŒ è¯·æ±‚å¤±è´¥</option>';
            }
        }

        // æŸ¥çœ‹æ—¥å¿—
        async function viewLog() {
            const filename = document.getElementById('log-files').value;
            if (!filename) return;
            
            const contentDiv = document.getElementById('log-content');
            contentDiv.textContent = 'åŠ è½½ä¸­...';
            
            try {
                const response = await axios.get(`/api/logs/view/${filename}`);
                
                if (response.data.ok) {
                    contentDiv.textContent = response.data.content;
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    contentDiv.scrollTop = contentDiv.scrollHeight;
                } else {
                    contentDiv.textContent = 'âŒ åŠ è½½å¤±è´¥: ' + response.data.error;
                }
            } catch (error) {
                contentDiv.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfigBrief() {
            console.log('[loadConfigBrief] å¼€å§‹åŠ è½½ brief.yaml');
            const pre = document.getElementById('config-brief');
            
            if (!pre) {
                console.error('[loadConfigBrief] æ‰¾ä¸åˆ° config-brief å…ƒç´ ');
                return;
            }
            
            pre.textContent = 'åŠ è½½ä¸­...';
            
            try {
                console.log('[loadConfigBrief] è¯·æ±‚ API: /api/config/brief');
                const response = await axios.get('/api/config/brief');
                console.log('[loadConfigBrief] å“åº”:', response.data.ok ? 'æˆåŠŸ' : 'å¤±è´¥');
                
                if (response.data.ok) {
                    pre.textContent = JSON.stringify(response.data.config, null, 2);
                    console.log('[loadConfigBrief] é…ç½®åŠ è½½æˆåŠŸ');
                } else {
                    pre.textContent = 'âŒ åŠ è½½å¤±è´¥: ' + response.data.error;
                    console.error('[loadConfigBrief] API è¿”å›é”™è¯¯:', response.data.error);
                }
            } catch (error) {
                pre.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
                console.error('[loadConfigBrief] è¯·æ±‚å¤±è´¥:', error);
            }
        }

        async function loadConfigChatlog() {
            console.log('[loadConfigChatlog] å¼€å§‹åŠ è½½ chatlog_automation.yaml');
            const pre = document.getElementById('config-chatlog');
            
            if (!pre) {
                console.error('[loadConfigChatlog] æ‰¾ä¸åˆ° config-chatlog å…ƒç´ ');
                return;
            }
            
            pre.textContent = 'åŠ è½½ä¸­...';
            
            try {
                console.log('[loadConfigChatlog] è¯·æ±‚ API: /api/config/chatlog');
                const response = await axios.get('/api/config/chatlog');
                console.log('[loadConfigChatlog] å“åº”:', response.data.ok ? 'æˆåŠŸ' : 'å¤±è´¥');
                
                if (response.data.ok) {
                    pre.textContent = JSON.stringify(response.data.config, null, 2);
                    console.log('[loadConfigChatlog] é…ç½®åŠ è½½æˆåŠŸ');
                } else {
                    pre.textContent = 'âŒ åŠ è½½å¤±è´¥: ' + response.data.error;
                    console.error('[loadConfigChatlog] API è¿”å›é”™è¯¯:', response.data.error);
                }
            } catch (error) {
                pre.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
                console.error('[loadConfigChatlog] è¯·æ±‚å¤±è´¥:', error);
            }
        }
        
        // ========== æ¯æ—¥å¤ç›˜ç›¸å…³å‡½æ•° ==========
        
        let selectedTalkers = [];
        let autoRefreshBatchesInterval = null;
        let autoRefreshCountdown = 5;
        let countdownInterval = null;
        let progressStartTime = null;  // è®°å½•å¤„ç†å¼€å§‹æ—¶é—´
        let taskStartTimes = {};       // è®°å½•æ¯ä¸ªä»»åŠ¡çš„å¼€å§‹æ—¶é—´
        
        // è‡ªåŠ¨åˆ·æ–°æ‰¹æ¬¡åˆ—è¡¨
        function toggleAutoRefreshBatches() {
            const checkbox = document.getElementById('auto-refresh-batches');
            const countdownEl = document.getElementById('refresh-countdown');
            
            if (checkbox && checkbox.checked) {
                // å¯ç”¨è‡ªåŠ¨åˆ·æ–°
                loadRecapBatches(); // ç«‹å³åˆ·æ–°ä¸€æ¬¡
                
                autoRefreshCountdown = 5;
                countdownEl.classList.remove('hidden');
                updateRefreshCountdown();
                
                // å€’è®¡æ—¶æ›´æ–°
                countdownInterval = setInterval(() => {
                    autoRefreshCountdown--;
                    updateRefreshCountdown();
                    
                    if (autoRefreshCountdown <= 0) {
                        autoRefreshCountdown = 5;
                        loadRecapBatches();
                    }
                }, 1000);
                
                console.log('[è‡ªåŠ¨åˆ·æ–°] å·²å¯ç”¨æ‰¹æ¬¡åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°');
            } else {
                // ç¦ç”¨è‡ªåŠ¨åˆ·æ–°
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                countdownEl.classList.add('hidden');
                console.log('[è‡ªåŠ¨åˆ·æ–°] å·²ç¦ç”¨æ‰¹æ¬¡åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°');
            }
        }
        
        function updateRefreshCountdown() {
            const countdownEl = document.getElementById('refresh-countdown');
            if (countdownEl) {
                countdownEl.textContent = `(${autoRefreshCountdown}s)`;
            }
        }
        
        // åŠ è½½æ¨¡æ¿åˆ—è¡¨åˆ°æ¯æ—¥å¤ç›˜é¡µé¢
        async function loadRecapTemplates() {
            const templateSelect = document.getElementById('recap-template');
            if (!templateSelect) return;
            
            try {
                const response = await axios.get('/api/templates');
                if (response.data.ok) {
                    const templates = response.data.templates || [];
                    
                    // ä¿ç•™é»˜è®¤é€‰é¡¹
                    templateSelect.innerHTML = '<option value="">-- ä½¿ç”¨é»˜è®¤æ¨¡æ¿ --</option>';
                    
                    // æ·»åŠ æ¨¡æ¿é€‰é¡¹
                    templates.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = `${t.name} (${t.llm_type === 'all' ? 'é€šç”¨' : t.llm_type.toUpperCase()})`;
                        if (t.is_system) {
                            option.textContent += ' ğŸ“‹';
                        }
                        templateSelect.appendChild(option);
                    });
                    
                    console.log('[loadRecapTemplates] åŠ è½½äº†', templates.length, 'ä¸ªæ¨¡æ¿');
                }
            } catch (error) {
                console.error('[loadRecapTemplates] åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
            }
        }
        
        async function loadTalkers() {
            const button = event.target;
            const originalText = button.textContent;
            
            try {
                button.disabled = true;
                button.textContent = 'åŠ è½½ä¸­...';
                
                const response = await axios.get('/api/recap/talkers', {
                    params: { days: 7 }
                });
                
                if (response.data.ok) {
                    const talkers = response.data.talkers;
                    const container = document.getElementById('talkers-container');
                    const list = document.getElementById('talkers-list');
                    
                    if (!container || !list) {
                        throw new Error('é¡µé¢å…ƒç´ æœªæ‰¾åˆ°');
                    }
                    
                    list.innerHTML = '';
                    selectedTalkers = [];
                    
                    talkers.forEach(t => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center p-2 hover:bg-gray-50';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `talker-${t.talker}`;
                        checkbox.value = t.talker;
                        checkbox.className = 'mr-2';
                        checkbox.onchange = () => toggleTalker(t.talker);
                        
                        const label = document.createElement('label');
                        label.htmlFor = `talker-${t.talker}`;
                        label.className = 'text-sm flex-1 cursor-pointer';
                        label.innerHTML = `${t.display_name} <span class="text-gray-500">(${t.message_count} æ¡æ¶ˆæ¯)</span>`;
                        
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        list.appendChild(div);
                    });
                    
                    container.classList.remove('hidden');
                } else {
                    alert('âŒ åŠ è½½å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                console.error('Load talkers error:', error);
                alert('âŒ åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }
        
        function toggleTalker(talker) {
            console.log('ğŸ” [DEBUG] toggleTalker è¢«è°ƒç”¨, talker:', talker);
            const checkbox = document.getElementById(`talker-${talker}`);
            if (!checkbox) {
                console.warn('âŒ [DEBUG] æ‰¾ä¸åˆ° checkbox, talker:', talker);
                return;
            }
            
            console.log('ğŸ” [DEBUG] checkbox.checked:', checkbox.checked);
            
            if (checkbox.checked) {
                if (!selectedTalkers.includes(talker)) {
                    selectedTalkers.push(talker);
                    console.log('âœ… [DEBUG] æ·»åŠ ç¾¤èŠåˆ°é€‰æ‹©åˆ—è¡¨:', talker);
                }
            } else {
                selectedTalkers = selectedTalkers.filter(t => t !== talker);
                console.log('â– [DEBUG] ä»é€‰æ‹©åˆ—è¡¨ç§»é™¤ç¾¤èŠ:', talker);
            }
            
            console.log('ğŸ” [DEBUG] å½“å‰ selectedTalkers:', selectedTalkers);
        }
        
        async function createRecapBatch() {
            console.log('ğŸ” [DEBUG] createRecapBatch å‡½æ•°è¢«è°ƒç”¨');
            console.log('ğŸ” [DEBUG] selectedTalkers:', selectedTalkers);
            console.log('ğŸ” [DEBUG] selectedTalkers.length:', selectedTalkers.length);
            
            if (selectedTalkers.length === 0) {
                console.log('âŒ [DEBUG] æ²¡æœ‰é€‰æ‹©ç¾¤èŠ');
                alert('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç¾¤èŠ');
                return;
            }
            
            console.log('âœ… [DEBUG] å·²é€‰æ‹©ç¾¤èŠï¼Œç›´æ¥å¼€å§‹åˆ›å»ºæ‰¹æ¬¡ï¼ˆå·²ç§»é™¤ç¡®è®¤å¯¹è¯æ¡†ï¼‰');
            const button = event.target;
            const originalText = button.textContent;
            console.log('ğŸ” [DEBUG] æŒ‰é’®å…ƒç´ :', button);
            console.log('ğŸ” [DEBUG] æŒ‰é’®åŸå§‹æ–‡å­—:', originalText);
            
            try {
                console.log('âœ… [DEBUG] è¿›å…¥ try å—');
                button.disabled = true;
                button.textContent = 'åˆ›å»ºä¸­...';
                console.log('âœ… [DEBUG] æŒ‰é’®å·²ç¦ç”¨ï¼Œæ–‡å­—å·²æ›´æ–°ä¸º"åˆ›å»ºä¸­..."');
                
                // è·å–æ—¥æœŸèŒƒå›´
                const dateStart = document.getElementById('recap-date-start').value;
                const dateEnd = document.getElementById('recap-date-end').value;
                
                if (!dateStart || !dateEnd) {
                    alert('âš ï¸ è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
                    return;
                }
                
                // è·å–é€‰ä¸­çš„ LLM
                const selectedLLMs = [];
                const llmCheckboxes = ['chatgpt', 'gemini', 'grok', 'perplexity', 'qianwen'];
                llmCheckboxes.forEach(llm => {
                    const checkbox = document.getElementById(`llm-${llm}`);
                    if (checkbox && checkbox.checked) {
                        selectedLLMs.push(llm);
                    }
                });
                
                if (selectedLLMs.length === 0) {
                    alert('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ª LLM');
                    return;
                }
                
                const model = document.getElementById('recap-model').value;
                const templateId = document.getElementById('recap-template').value;
                const isPublic = document.getElementById('recap-public').checked;
                
                console.log('ğŸ” [DEBUG] è¡¨å•æ•°æ®:');
                console.log('  - dateStart:', dateStart);
                console.log('  - dateEnd:', dateEnd);
                console.log('  - selectedLLMs:', selectedLLMs);
                console.log('  - model:', model);
                console.log('  - templateId:', templateId || '(é»˜è®¤)');
                console.log('  - isPublic:', isPublic);
                console.log('  - talkers:', selectedTalkers);
                
                // ä¸ºæ¯ä¸ª LLM åˆ›å»ºæ‰¹æ¬¡
                console.log('ğŸ“¤ [DEBUG] å‡†å¤‡ä¸º ' + selectedLLMs.length + ' ä¸ª LLM åˆ›å»ºæ‰¹æ¬¡...');
                const createdBatches = [];
                
                for (const llm of selectedLLMs) {
                    console.log('ğŸ“¤ [DEBUG] åˆ›å»ºæ‰¹æ¬¡ - LLM:', llm);
                    const createResponse = await axios.post('/api/recap/create', {
                        talkers: selectedTalkers,
                        date_start: dateStart,
                        date_end: dateEnd,
                        llm_site: llm,
                        model_version: model,
                        template_id: templateId || null,
                        public: isPublic
                    });
                    
                    if (createResponse.data.ok) {
                        createdBatches.push({
                            llm: llm,
                            batch_id: createResponse.data.batch_id
                        });
                        console.log('âœ… [DEBUG] æ‰¹æ¬¡åˆ›å»ºæˆåŠŸ -', llm, '- ID:', createResponse.data.batch_id);
                    } else {
                        console.error('âŒ [DEBUG] æ‰¹æ¬¡åˆ›å»ºå¤±è´¥ -', llm, ':', createResponse.data.error);
                    }
                }
                
                if (createdBatches.length === 0) {
                    console.error('âŒ [DEBUG] æ‰€æœ‰æ‰¹æ¬¡åˆ›å»ºå¤±è´¥');
                    alert('âŒ æ‰€æœ‰æ‰¹æ¬¡åˆ›å»ºå¤±è´¥');
                    return;
                }
                
                console.log('âœ… [DEBUG] æˆåŠŸåˆ›å»º ' + createdBatches.length + ' ä¸ªæ‰¹æ¬¡');
                alert(`âœ… æˆåŠŸåˆ›å»º ${createdBatches.length} ä¸ªæ‰¹æ¬¡ï¼\n${createdBatches.map(b => `${b.llm}: ${b.batch_id}`).join('\n')}`);
                
                // ä¸ºæ¯ä¸ªæ‰¹æ¬¡å¯åŠ¨å¤„ç†
                for (const batch of createdBatches) {
                    console.log('ğŸš€ [DEBUG] å¯åŠ¨æ‰¹æ¬¡å¤„ç† -', batch.llm, '-', batch.batch_id);
                    
                    try {
                        const processResponse = await axios.post(`/api/recap/process/${batch.batch_id}`, {
                            timeout: 1200
                        });
                        
                        if (processResponse.data.ok) {
                            console.log('âœ… [DEBUG] å¤„ç†å·²å¯åŠ¨ -', batch.llm);
                        } else {
                            console.error('âŒ [DEBUG] å¯åŠ¨å¤„ç†å¤±è´¥ -', batch.llm, ':', processResponse.data.error);
                        }
                    } catch (error) {
                        console.error('âŒ [DEBUG] å¯åŠ¨å¤„ç†å¼‚å¸¸ -', batch.llm, ':', error.message);
                    }
                }
                
                // æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ‰¹æ¬¡çš„è¿›åº¦ç›‘æ§
                if (createdBatches.length > 0) {
                    console.log('ğŸ“Š [DEBUG] æ˜¾ç¤ºè¿›åº¦ç›‘æ§ç•Œé¢...');
                    showProgressMonitor(createdBatches[0].batch_id);
                    startProgressPolling(createdBatches[0].batch_id);
                }
                
                // åˆ·æ–°æ‰¹æ¬¡åˆ—è¡¨
                setTimeout(() => {
                    loadRecapBatches();
                }, 2000);
                
            } catch (error) {
                console.error('âŒâŒâŒ [DEBUG] æ•è·åˆ°é”™è¯¯:', error);
                console.error('âŒ [DEBUG] é”™è¯¯è¯¦æƒ…:', {
                    message: error.message,
                    stack: error.stack,
                    response: error.response?.data
                });
                alert('âŒ æ“ä½œå¤±è´¥: ' + error.message + '\nè¯·æŸ¥çœ‹ Console äº†è§£è¯¦æƒ…');
            } finally {
                console.log('ğŸ” [DEBUG] è¿›å…¥ finally å—');
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                    console.log('âœ… [DEBUG] æŒ‰é’®çŠ¶æ€å·²æ¢å¤');
                }
            }
        }
        
        async function loadRecapBatches() {
            try {
                const response = await axios.get('/api/recap/batches', {
                    params: { limit: 50 }
                });
                
                if (response.data.ok) {
                    const batches = response.data.batches;
                    const container = document.getElementById('recap-batches-list');
                    
                    if (batches.length === 0) {
                        container.innerHTML = '<p class="text-sm text-gray-500">æš‚æ— å¤ç›˜æ‰¹æ¬¡</p>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    
                    batches.forEach(batch => {
                        const completedCount = batch.tasks.filter(t => t.status === 'completed').length;
                        const totalCount = batch.tasks.length;
                        
                        // è®¡ç®—å¤„ç†è€—æ—¶
                        let durationText = '';
                        if (batch.created_at && batch.completed_at) {
                            const start = new Date(batch.created_at);
                            const end = new Date(batch.completed_at);
                            const durationSeconds = (end - start) / 1000;
                            const minutes = Math.floor(durationSeconds / 60);
                            const seconds = Math.floor(durationSeconds % 60);
                            
                            if (minutes > 0) {
                                durationText = `â±ï¸ è€—æ—¶: ${minutes}åˆ†${seconds}ç§’`;
                            } else {
                                durationText = `â±ï¸ è€—æ—¶: ${seconds}ç§’`;
                            }
                        } else if (batch.created_at && batch.status === 'processing') {
                            const start = new Date(batch.created_at);
                            const now = new Date();
                            const durationSeconds = (now - start) / 1000;
                            const minutes = Math.floor(durationSeconds / 60);
                            durationText = `â±ï¸ å·²è¿è¡Œ: ${minutes}åˆ†é’Ÿ`;
                        }
                        
                        let statusBadge = '';
                        if (batch.status === 'completed') {
                            statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">âœ… å®Œæˆ</span>';
                        } else if (batch.status === 'processing') {
                            statusBadge = '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">â³ å¤„ç†ä¸­</span>';
                        } else if (batch.status === 'failed') {
                            statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">âŒ å¤±è´¥</span>';
                        } else if (batch.status === 'partial') {
                            statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">âš ï¸ éƒ¨åˆ†å®Œæˆ</span>';
                        } else {
                            statusBadge = '<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded">å¾…å¤„ç†</span>';
                        }
                        
                        const div = document.createElement('div');
                        div.className = 'border border-gray-200 rounded-lg p-3 mb-3 hover:bg-gray-50 cursor-pointer';
                        div.onclick = () => showBatchDetail(batch.batch_id);
                        div.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold text-sm">${batch.date}</span>
                                ${statusBadge}
                            </div>
                            <div class="text-xs text-gray-600">
                                <div>æ‰¹æ¬¡ID: ${batch.batch_id}</div>
                                <div>è¿›åº¦: ${completedCount}/${totalCount}</div>
                                <div>LLM: ${batch.llm_site} (${batch.model_version})</div>
                                ${durationText ? `<div class="text-blue-600 font-semibold">${durationText}</div>` : ''}
                                ${batch.public ? '<div class="text-blue-600">ğŸŒ å·²å…¬å¼€</div>' : ''}
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    alert('âŒ åŠ è½½å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                console.error('Load batches error:', error);
                alert('âŒ åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // ç”Ÿæˆ Obsidian URI é“¾æ¥
        function generateObsidianUri(filePath) {
            if (!filePath) return null;
            
            // Obsidian vault åç§°ï¼ˆä»è·¯å¾„ä¸­æå–ï¼‰
            // å‡è®¾è·¯å¾„æ ¼å¼ï¼š/Users/xxx/work/personal/obsidian/personal/10_Sources/...
            // vault åç§°æ˜¯ "personal"
            const vaultMatch = filePath.match(/obsidian\/([^\/]+)\//);
            if (!vaultMatch) return null;
            
            const vaultName = vaultMatch[1];
            
            // æå–ç›¸å¯¹äº vault çš„æ–‡ä»¶è·¯å¾„
            const vaultPath = filePath.substring(filePath.indexOf(`obsidian/${vaultName}/`) + `obsidian/${vaultName}/`.length);
            
            // æ„å»º Obsidian URI
            // obsidian://open?vault=VAULT_NAME&file=FILE_PATH
            const encodedVault = encodeURIComponent(vaultName);
            const encodedFile = encodeURIComponent(vaultPath.replace(/\.md$/, '')); // Obsidian ä¸éœ€è¦ .md åç¼€
            
            return `obsidian://open?vault=${encodedVault}&file=${encodedFile}`;
        }
        
        async function showBatchDetail(batchId) {
            try {
                const response = await axios.get(`/api/recap/batch/${batchId}`);
                
                if (response.data.ok) {
                    const batch = response.data.batch;
                    const content = document.getElementById('batch-detail-content');
                    
                    let tasksHtml = '';
                    batch.tasks.forEach(task => {
                        let statusIcon = '';
                        if (task.status === 'completed') {
                            statusIcon = 'âœ…';
                        } else if (task.status === 'processing') {
                            statusIcon = 'â³';
                        } else if (task.status === 'failed') {
                            statusIcon = 'âŒ';
                        } else {
                            statusIcon = 'â¸';
                        }
                        
                        // ç”Ÿæˆ Obsidian é“¾æ¥
                        let resultPathHtml = '';
                        if (task.result_path) {
                            const obsidianUri = generateObsidianUri(task.result_path);
                            // è·å–æ–‡ä»¶åç”¨äºæ˜¾ç¤º
                            const fileName = task.result_path.split('/').pop();
                            
                            if (obsidianUri) {
                                resultPathHtml = `
                                    <div class="mt-2 p-2 bg-purple-50 border border-purple-200 rounded">
                                        <a href="${obsidianUri}" class="flex items-center gap-2 text-purple-700 hover:text-purple-900" title="ç‚¹å‡»åœ¨ Obsidian ä¸­æ‰“å¼€">
                                            <span class="text-lg">ğŸ”®</span>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-medium truncate">åœ¨ Obsidian ä¸­æ‰“å¼€</div>
                                                <div class="text-xs text-purple-500 truncate">${fileName}</div>
                                            </div>
                                            <span class="text-purple-400">â†’</span>
                                        </a>
                                    </div>
                                `;
                            } else {
                                resultPathHtml = `<div class="text-xs text-blue-600 mt-1">ğŸ“„ ${task.result_path}</div>`;
                            }
                        }
                        
                        tasksHtml += `
                            <div class="border-b border-gray-200 py-3">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">${statusIcon} ${task.display_name}</span>
                                    <span class="text-xs text-gray-500">${task.message_count || 0} æ¡æ¶ˆæ¯</span>
                                </div>
                                ${task.error_message ? `<div class="text-xs text-red-600 mt-1">é”™è¯¯: ${task.error_message}</div>` : ''}
                                ${resultPathHtml}
                            </div>
                        `;
                    });
                    
                    content.innerHTML = `
                        <div class="mb-4">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>æ‰¹æ¬¡ID:</strong> ${batch.batch_id}</div>
                                <div><strong>æ—¥æœŸ:</strong> ${batch.date}</div>
                                <div><strong>çŠ¶æ€:</strong> ${batch.status}</div>
                                <div><strong>LLM:</strong> ${batch.llm_site} (${batch.model_version})</div>
                                <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${batch.created_at || 'N/A'}</div>
                                <div><strong>å®Œæˆæ—¶é—´:</strong> ${batch.completed_at || 'N/A'}</div>
                            </div>
                            ${batch.public ? '<div class="mt-2 text-blue-600 text-sm">ğŸŒ æ­¤æ‰¹æ¬¡å·²å…¬å¼€åˆ†äº«</div>' : ''}
                        </div>
                        <div class="mb-2"><strong>ä»»åŠ¡åˆ—è¡¨:</strong></div>
                        <div class="max-h-96 overflow-y-auto">
                            ${tasksHtml}
                        </div>
                    `;
                    
                    document.getElementById('batch-detail-modal').classList.remove('hidden');
                } else {
                    alert('âŒ åŠ è½½å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                console.error('Show batch detail error:', error);
                alert('âŒ åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        function closeBatchDetail() {
            document.getElementById('batch-detail-modal').classList.add('hidden');
        }
        
        // è¿›åº¦ç›‘æ§ç›¸å…³å‡½æ•°
        let progressPollingInterval = null;
        
        function showProgressMonitor(batchId) {
            const monitor = document.getElementById('progress-monitor');
            if (monitor) {
                monitor.classList.remove('hidden');
                
                // åˆå§‹åŒ–è®¡æ—¶å™¨
                progressStartTime = new Date();
                taskStartTimes = {};
                
                updateProgressDisplay(batchId, {
                    status: 'pending',
                    message: 'ğŸš€ æ‰¹æ¬¡å·²åˆ›å»ºï¼Œæ­£åœ¨å¯åŠ¨å¤„ç†...',
                    batch_id: batchId
                });
                
                // å¯åŠ¨ 5 ç§’è‡ªåŠ¨åˆ·æ–°è¿›åº¦
                startProgressPolling(batchId);
            }
        }
        
        function hideProgressMonitor() {
            const monitor = document.getElementById('progress-monitor');
            if (monitor) {
                monitor.classList.add('hidden');
            }
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
            
            // é‡ç½®è®¡æ—¶å™¨
            progressStartTime = null;
            taskStartTimes = {};
            
            // æ¸…ç©ºé€‰æ‹©å¹¶åˆ·æ–°åˆ—è¡¨
            selectedTalkers = [];
            const talkersContainer = document.getElementById('talkers-container');
            if (talkersContainer) {
                talkersContainer.classList.add('hidden');
            }
            loadRecapBatches();
        }
        
        function updateProgressDisplay(batchId, data) {
            const content = document.getElementById('progress-content');
            if (!content) return;
            
            const now = new Date();
            const nowStr = now.toLocaleTimeString('zh-CN', { hour12: false });
            
            // è®¡ç®—æ€»è€—æ—¶
            let totalElapsed = '';
            if (progressStartTime) {
                const elapsed = Math.floor((now - progressStartTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                totalElapsed = mins > 0 ? `${mins}åˆ†${secs}ç§’` : `${secs}ç§’`;
            }
            
            let html = `
                <div class="font-mono text-xs">
                    <div class="flex justify-between mb-2">
                        <div>
                            <span class="text-gray-600">æ‰¹æ¬¡ID:</span> 
                            <span class="font-semibold">${batchId}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-gray-600">â±ï¸ æ€»è€—æ—¶:</span> 
                            <span class="font-semibold text-orange-600">${totalElapsed || 'è®¡æ—¶ä¸­...'}</span>
                        </div>
                    </div>
                    <div class="mb-2 text-gray-500">
                        æ›´æ–°äº: ${nowStr} (æ¯5ç§’è‡ªåŠ¨åˆ·æ–°)
                    </div>
            `;
            
            if (data.status === 'pending') {
                // è®°å½•å¼€å§‹æ—¶é—´
                if (!progressStartTime) {
                    progressStartTime = new Date();
                }
                html += `
                    <div class="flex items-center space-x-2 text-blue-700">
                        <span class="animate-pulse">â³</span>
                        <span>${data.message || 'ç­‰å¾…å¤„ç†...'}</span>
                    </div>
                `;
            } else if (data.status === 'processing' || data.batch?.status === 'processing') {
                const batch = data.batch || data;
                const tasks = batch.tasks || [];
                const completedCount = tasks.filter(t => t.status === 'completed').length;
                const failedCount = tasks.filter(t => t.status === 'failed').length;
                const processingTasks = tasks.filter(t => t.status === 'processing');
                
                html += `
                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span>æ€»è¿›åº¦:</span>
                            <span class="font-semibold">${completedCount + failedCount}/${tasks.length}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                 style="width: ${(completedCount + failedCount) / tasks.length * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        ${tasks.map((task, index) => {
                            let icon = 'â¸ï¸';
                            let statusText = 'å¾…å¤„ç†';
                            let colorClass = 'text-gray-600';
                            let durationText = '';
                            
                            // è·Ÿè¸ªä»»åŠ¡æ—¶é—´
                            const taskKey = `${batchId}_${index}`;
                            
                            if (task.status === 'completed') {
                                icon = 'âœ…';
                                colorClass = 'text-green-600';
                                // è®¡ç®—ä»»åŠ¡è€—æ—¶
                                if (task.created_at && task.completed_at) {
                                    const taskDuration = Math.floor((new Date(task.completed_at) - new Date(task.created_at)) / 1000);
                                    const taskMins = Math.floor(taskDuration / 60);
                                    const taskSecs = taskDuration % 60;
                                    durationText = taskMins > 0 ? `â±ï¸ ${taskMins}åˆ†${taskSecs}ç§’` : `â±ï¸ ${taskSecs}ç§’`;
                                }
                                statusText = 'å·²å®Œæˆ ' + durationText;
                            } else if (task.status === 'processing') {
                                icon = 'â³';
                                colorClass = 'text-blue-600 animate-pulse';
                                // è®°å½•å¤„ç†ä¸­ä»»åŠ¡çš„å¼€å§‹æ—¶é—´
                                if (!taskStartTimes[taskKey]) {
                                    taskStartTimes[taskKey] = new Date();
                                }
                                const processingTime = Math.floor((now - taskStartTimes[taskKey]) / 1000);
                                const pMins = Math.floor(processingTime / 60);
                                const pSecs = processingTime % 60;
                                statusText = `å¤„ç†ä¸­... ${pMins > 0 ? pMins + 'åˆ†' : ''}${pSecs}ç§’`;
                            } else if (task.status === 'failed') {
                                icon = 'âŒ';
                                statusText = 'å¤±è´¥';
                                colorClass = 'text-red-600';
                            }
                            
                            return `
                                <div class="flex items-start space-x-2 p-2 bg-white rounded border border-gray-200">
                                    <span class="${colorClass}">${icon}</span>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium text-sm truncate">${task.display_name || task.talker}</span>
                                            <span class="text-xs text-gray-400">#${index + 1}</span>
                                        </div>
                                        <div class="text-xs ${colorClass}">${statusText}</div>
                                        ${task.message_count ? `<div class="text-xs text-gray-500">ğŸ“ ${task.message_count} æ¡æ¶ˆæ¯</div>` : ''}
                                        ${task.error_message ? `<div class="text-xs text-red-600 mt-1">â— ${task.error_message.substring(0, 50)}...</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                if (processingTasks.length > 0) {
                    html += `
                        <div class="mt-3 text-xs text-blue-600 flex items-center space-x-2">
                            <span class="animate-spin">ğŸ”„</span>
                            <span>æ­£åœ¨å¤„ç†: ${processingTasks.map(t => t.display_name || t.talker).join(', ')}</span>
                        </div>
                    `;
                }
            } else if (data.status === 'completed' || data.batch?.status === 'completed') {
                const batch = data.batch || data;
                const tasks = batch.tasks || [];
                const completedCount = tasks.filter(t => t.status === 'completed').length;
                const failedCount = tasks.filter(t => t.status === 'failed').length;
                
                html += `
                    <div class="text-green-700 font-semibold mb-2">
                        âœ… æ‰¹æ¬¡å¤„ç†å®Œæˆï¼
                    </div>
                    <div class="text-sm">
                        <div>âœ… æˆåŠŸ: ${completedCount} ä¸ªä»»åŠ¡</div>
                        ${failedCount > 0 ? `<div>âŒ å¤±è´¥: ${failedCount} ä¸ªä»»åŠ¡</div>` : ''}
                    </div>
                    <button onclick="hideProgressMonitor()" class="mt-3 px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                        ç¡®è®¤å¹¶å…³é—­
                    </button>
                `;
                
                // è‡ªåŠ¨åœæ­¢è½®è¯¢
                if (progressPollingInterval) {
                    clearInterval(progressPollingInterval);
                    progressPollingInterval = null;
                }
            } else if (data.status === 'failed' || data.batch?.status === 'failed') {
                html += `
                    <div class="text-red-700 font-semibold mb-2">
                        âŒ æ‰¹æ¬¡å¤„ç†å¤±è´¥
                    </div>
                    <div class="text-sm text-red-600">
                        ${data.error || 'è¯·æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…'}
                    </div>
                    <button onclick="hideProgressMonitor()" class="mt-3 px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                        å…³é—­
                    </button>
                `;
                
                // è‡ªåŠ¨åœæ­¢è½®è¯¢
                if (progressPollingInterval) {
                    clearInterval(progressPollingInterval);
                    progressPollingInterval = null;
                }
            }
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        function startProgressPolling(batchId) {
            // æ¸…é™¤å·²æœ‰çš„è½®è¯¢
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
            }
            
            // ç«‹å³è·å–ä¸€æ¬¡çŠ¶æ€
            updateProgress(batchId);
            
            // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
            progressPollingInterval = setInterval(() => {
                updateProgress(batchId);
            }, 5000);
        }
        
        async function updateProgress(batchId) {
            try {
                const response = await axios.get(`/api/recap/batch/${batchId}`);
                if (response.data.ok) {
                    updateProgressDisplay(batchId, response.data);
                }
            } catch (error) {
                console.error('Update progress error:', error);
            }
        }
        
        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… [DEBUG] DOM åŠ è½½å®Œæˆ');
            const today = new Date().toISOString().split('T')[0];
            
            // è®¾ç½®å¼€å§‹å’Œç»“æŸæ—¥æœŸéƒ½ä¸ºä»Šå¤©
            const dateStartInput = document.getElementById('recap-date-start');
            const dateEndInput = document.getElementById('recap-date-end');
            
            if (dateStartInput) {
                dateStartInput.value = today;
                console.log('âœ… [DEBUG] å¼€å§‹æ—¥æœŸåˆå§‹åŒ–ä¸º:', today);
            }
            
            if (dateEndInput) {
                dateEndInput.value = today;
                console.log('âœ… [DEBUG] ç»“æŸæ—¥æœŸåˆå§‹åŒ–ä¸º:', today);
            }
            
            console.log('âœ… [DEBUG] selectedTalkers åˆå§‹åŒ–ä¸º:', selectedTalkers);
        });
        
        // ========== æ¨¡æ¿ç®¡ç†ç›¸å…³å‡½æ•° ==========
        
        let currentEditingTemplateId = null;
        
        async function loadTemplates() {
            console.log('[loadTemplates] å¼€å§‹åŠ è½½æ¨¡æ¿åˆ—è¡¨');
            const llmFilter = document.getElementById('template-llm-filter');
            const container = document.getElementById('templates-list');
            
            console.log('[loadTemplates] llmFilter:', llmFilter);
            console.log('[loadTemplates] container:', container);
            
            if (!container) {
                console.error('[loadTemplates] âŒ æ‰¾ä¸åˆ° templates-list å®¹å™¨ï¼');
                return;
            }
            
            const filterValue = llmFilter ? llmFilter.value : '';
            
            try {
                const params = filterValue ? `?llm_type=${filterValue}` : '';
                console.log('[loadTemplates] è¯·æ±‚ API:', `/api/templates${params}`);
                const response = await axios.get(`/api/templates${params}`);
                
                if (response.data.ok) {
                    const templates = response.data.templates;
                    console.log('[loadTemplates] åŠ è½½äº†', templates.length, 'ä¸ªæ¨¡æ¿');
                    console.log('[loadTemplates] æ¨¡æ¿æ•°æ®:', templates);
                    
                    if (templates.length === 0) {
                        container.innerHTML = '<div class="text-gray-500 text-sm p-4 text-center">æš‚æ— æ¨¡æ¿</div>';
                        return;
                    }
                    
                    const html = templates.map(t => {
                        const typeLabel = t.llm_type === 'all' ? 'é€šç”¨' : t.llm_type.toUpperCase();
                        const typeColor = t.llm_type === 'chatgpt' ? 'bg-green-100 text-green-800' : 
                                         t.llm_type === 'gemini' ? 'bg-blue-100 text-blue-800' : 
                                         'bg-gray-100 text-gray-800';
                        const systemBadge = t.is_system ? '<span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded">ç³»ç»Ÿ</span>' : '';
                        const baseBadge = t.base_template_id ? '<span class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-800 text-xs rounded">æ‰©å±•</span>' : '';
                        
                        return `
                            <div class="p-3 border rounded hover:bg-gray-50 cursor-pointer" onclick="viewTemplate('${t.id}')">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="font-medium text-sm">${t.name}${systemBadge}${baseBadge}</div>
                                    <span class="px-2 py-0.5 ${typeColor} text-xs rounded">${typeLabel}</span>
                                </div>
                                <div class="text-xs text-gray-500 mb-2">${t.description || 'æ— æè¿°'}</div>
                                <div class="flex items-center justify-between text-xs text-gray-400">
                                    <span>ID: ${t.id}</span>
                                    <div class="space-x-2">
                                        ${!t.is_system ? `
                                            <button onclick="event.stopPropagation(); editTemplate('${t.id}')" class="text-blue-600 hover:text-blue-800">ç¼–è¾‘</button>
                                            <button onclick="event.stopPropagation(); deleteTemplate('${t.id}')" class="text-red-600 hover:text-red-800">åˆ é™¤</button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    console.log('[loadTemplates] ç”Ÿæˆçš„ HTML é•¿åº¦:', html.length);
                    container.innerHTML = html;
                    console.log('[loadTemplates] âœ… æ¸²æŸ“å®Œæˆ');
                } else {
                    console.error('[loadTemplates] API è¿”å› ok=false');
                    container.innerHTML = '<div class="text-red-500 text-sm p-4">âŒ åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('[loadTemplates] åŠ è½½å¤±è´¥:', error);
                container.innerHTML = '<div class="text-red-500 text-sm p-4">âŒ è¯·æ±‚å¤±è´¥</div>';
            }
        }
        
        async function loadMappings() {
            console.log('[loadMappings] å¼€å§‹åŠ è½½æ˜ å°„åˆ—è¡¨');
            const container = document.getElementById('mappings-list');
            
            try {
                const response = await axios.get('/api/template-mappings');
                
                if (response.data.ok) {
                    const mappings = response.data.mappings;
                    console.log('[loadMappings] åŠ è½½äº†', mappings.length, 'ä¸ªæ˜ å°„');
                    
                    if (mappings.length === 0) {
                        container.innerHTML = '<div class="text-gray-500 text-sm p-4 text-center">æš‚æ— æ˜ å°„</div>';
                        return;
                    }
                    
                    container.innerHTML = mappings.map(m => {
                        const llmLabel = m.llm_type || 'é»˜è®¤';
                        
                        return `
                            <div class="p-3 border rounded hover:bg-gray-50">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="font-medium text-sm">${m.talker}</div>
                                    <button onclick="deleteMapping('${m.talker}')" class="text-red-600 hover:text-red-800 text-xs">åˆ é™¤</button>
                                </div>
                                <div class="text-xs text-gray-500">
                                    æ¨¡æ¿: ${m.template_id}
                                    ${m.llm_type ? `<span class="ml-2 text-gray-400">(${llmLabel})</span>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="text-red-500 text-sm p-4">âŒ åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('[loadMappings] åŠ è½½å¤±è´¥:', error);
                container.innerHTML = '<div class="text-red-500 text-sm p-4">âŒ è¯·æ±‚å¤±è´¥</div>';
            }
        }
        
        function showCreateTemplateModal() {
            currentEditingTemplateId = null;
            document.getElementById('template-modal-title').textContent = 'åˆ›å»ºæ¨¡æ¿';
            document.getElementById('template-id').value = '';
            document.getElementById('template-id').disabled = false;
            document.getElementById('template-name').value = '';
            document.getElementById('template-description').value = '';
            document.getElementById('template-llm-type').value = 'all';
            document.getElementById('template-base').value = '';
            document.getElementById('template-content').value = '';
            
            // åŠ è½½åŸºç¡€æ¨¡æ¿é€‰é¡¹
            loadBaseTemplateOptions();
            
            document.getElementById('template-modal').classList.remove('hidden');
        }
        
        function hideTemplateModal() {
            document.getElementById('template-modal').classList.add('hidden');
        }
        
        async function loadBaseTemplateOptions() {
            try {
                const response = await axios.get('/api/templates');
                if (response.data.ok) {
                    const select = document.getElementById('template-base');
                    const currentValue = select.value;
                    
                    select.innerHTML = '<option value="">æ— ï¼ˆç‹¬ç«‹æ¨¡æ¿ï¼‰</option>';
                    response.data.templates.forEach(t => {
                        if (!currentEditingTemplateId || t.id !== currentEditingTemplateId) {
                            const option = document.createElement('option');
                            option.value = t.id;
                            option.textContent = `${t.name} (${t.id})`;
                            select.appendChild(option);
                        }
                    });
                    
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½åŸºç¡€æ¨¡æ¿é€‰é¡¹å¤±è´¥:', error);
            }
        }
        
        // å­˜å‚¨å½“å‰æŸ¥çœ‹çš„æ¨¡æ¿å†…å®¹ï¼ˆç”¨äºå¤åˆ¶ï¼‰
        let currentTemplateContent = '';
        
        async function viewTemplate(templateId) {
            const previewContent = document.getElementById('template-preview-content');
            const closeBtn = document.getElementById('close-preview-btn');
            const copyBtn = document.getElementById('copy-template-btn');
            
            if (!previewContent) {
                console.error('æ‰¾ä¸åˆ°é¢„è§ˆåŒºåŸŸ');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            previewContent.innerHTML = '<p class="text-gray-500">â³ åŠ è½½ä¸­...</p>';
            currentTemplateContent = '';
            
            try {
                // è·å–æ¨¡æ¿è¯¦æƒ…å’Œå†…å®¹
                const [detailRes, contentRes] = await Promise.all([
                    axios.get(`/api/templates/${templateId}`),
                    axios.get(`/api/templates/${templateId}/content`)
                ]);
                
                if (contentRes.data.ok) {
                    const template = detailRes.data.template || {};
                    const content = contentRes.data.content || '(æ— å†…å®¹)';
                    
                    // ä¿å­˜åŸå§‹å†…å®¹ç”¨äºå¤åˆ¶
                    currentTemplateContent = content;
                    
                    // æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆä¿æŒåŸå§‹ Markdown æ ¼å¼ï¼‰
                    previewContent.innerHTML = `
                        <div class="mb-3 pb-3 border-b border-gray-200">
                            <div class="font-semibold text-gray-800">${escapeHtml(template.name || templateId)}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                ID: ${templateId} | 
                                LLM: ${template.llm_type || 'all'} | 
                                ${template.is_system ? 'ç³»ç»Ÿæ¨¡æ¿' : 'è‡ªå®šä¹‰æ¨¡æ¿'}
                                ${template.base_template_id ? ' | ç»§æ‰¿è‡ª: ' + template.base_template_id : ''}
                            </div>
                            ${template.description ? '<div class="text-sm text-gray-600 mt-2">' + escapeHtml(template.description) + '</div>' : ''}
                        </div>
                        <pre class="whitespace-pre-wrap text-xs font-mono text-gray-700 leading-relaxed bg-white p-3 rounded border border-gray-100">${escapeHtml(content)}</pre>
                    `;
                    
                    // æ˜¾ç¤ºæŒ‰é’®
                    if (closeBtn) closeBtn.classList.remove('hidden');
                    if (copyBtn) copyBtn.classList.remove('hidden');
                } else {
                    previewContent.innerHTML = `<p class="text-red-500">âŒ è·å–æ¨¡æ¿å†…å®¹å¤±è´¥: ${contentRes.data.error}</p>`;
                }
            } catch (error) {
                console.error('æŸ¥çœ‹æ¨¡æ¿å¤±è´¥:', error);
                previewContent.innerHTML = `<p class="text-red-500">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        function closeTemplatePreview() {
            const previewContent = document.getElementById('template-preview-content');
            const closeBtn = document.getElementById('close-preview-btn');
            const copyBtn = document.getElementById('copy-template-btn');
            
            if (previewContent) {
                previewContent.innerHTML = '<p class="text-gray-500 italic">ç‚¹å‡»å·¦ä¾§æ¨¡æ¿æŸ¥çœ‹å†…å®¹</p>';
            }
            if (closeBtn) closeBtn.classList.add('hidden');
            if (copyBtn) copyBtn.classList.add('hidden');
            currentTemplateContent = '';
        }
        
        async function copyTemplateContent() {
            const copyBtn = document.getElementById('copy-template-btn');
            
            if (!currentTemplateContent) {
                alert('âŒ æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(currentTemplateContent);
                
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸåé¦ˆ
                if (copyBtn) {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
                    copyBtn.classList.remove('text-blue-600', 'hover:text-blue-800');
                    copyBtn.classList.add('text-green-600');
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.classList.remove('text-green-600');
                        copyBtn.classList.add('text-blue-600', 'hover:text-blue-800');
                    }, 2000);
                }
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                alert('âŒ å¤åˆ¶å¤±è´¥: ' + error.message);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function editTemplate(templateId) {
            try {
                const response = await axios.get(`/api/templates/${templateId}`);
                if (response.data.ok) {
                    const t = response.data.template;
                    currentEditingTemplateId = templateId;
                    
                    document.getElementById('template-modal-title').textContent = 'ç¼–è¾‘æ¨¡æ¿';
                    document.getElementById('template-id').value = t.id;
                    document.getElementById('template-id').disabled = true;
                    document.getElementById('template-name').value = t.name;
                    document.getElementById('template-description').value = t.description || '';
                    document.getElementById('template-llm-type').value = t.llm_type;
                    document.getElementById('template-base').value = t.base_template_id || '';
                    document.getElementById('template-content').value = t.content;
                    
                    await loadBaseTemplateOptions();
                    
                    document.getElementById('template-modal').classList.remove('hidden');
                } else {
                    alert('âŒ è·å–æ¨¡æ¿å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                console.error('ç¼–è¾‘æ¨¡æ¿å¤±è´¥:', error);
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        async function saveTemplate() {
            const id = document.getElementById('template-id').value.trim();
            const name = document.getElementById('template-name').value.trim();
            const description = document.getElementById('template-description').value.trim();
            const llmType = document.getElementById('template-llm-type').value;
            const baseTemplateId = document.getElementById('template-base').value || null;
            const content = document.getElementById('template-content').value.trim();
            
            if (!id || !name || !content) {
                alert('è¯·å¡«å†™å¿…å¡«å­—æ®µï¼ˆIDã€åç§°ã€å†…å®¹ï¼‰');
                return;
            }
            
            // éªŒè¯ ID æ ¼å¼
            if (!/^[a-z0-9_]+$/.test(id)) {
                alert('æ¨¡æ¿ ID åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
                return;
            }
            
            try {
                const data = {
                    id,
                    name,
                    description,
                    llm_type: llmType,
                    base_template_id: baseTemplateId,
                    content
                };
                
                let response;
                if (currentEditingTemplateId) {
                    // æ›´æ–°
                    response = await axios.put(`/api/templates/${currentEditingTemplateId}`, data);
                } else {
                    // åˆ›å»º
                    response = await axios.post('/api/templates', data);
                }
                
                if (response.data.ok) {
                    alert('âœ… ä¿å­˜æˆåŠŸï¼');
                    hideTemplateModal();
                    loadTemplates();
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜æ¨¡æ¿å¤±è´¥:', error);
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        async function deleteTemplate(templateId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${templateId}" å—ï¼Ÿ\n\næ³¨æ„ï¼šå¦‚æœæœ‰å…¶ä»–æ¨¡æ¿ä¾èµ–æ­¤æ¨¡æ¿ï¼Œæˆ–æœ‰ç¾¤èŠä½¿ç”¨æ­¤æ¨¡æ¿ï¼Œå°†æ— æ³•åˆ é™¤ã€‚`)) {
                return;
            }
            
            try {
                const response = await axios.delete(`/api/templates/${templateId}`);
                if (response.data.ok) {
                    alert('âœ… åˆ é™¤æˆåŠŸï¼');
                    loadTemplates();
                    loadMappings();
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤æ¨¡æ¿å¤±è´¥:', error);
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        async function showCreateMappingModal() {
            // åŠ è½½ç¾¤èŠåˆ—è¡¨
            try {
                const response = await axios.get('/api/recap/talkers?days=30');
                if (response.data.ok) {
                    const select = document.getElementById('mapping-talker');
                    select.innerHTML = '<option value="">-- é€‰æ‹©ç¾¤èŠ --</option>';
                    response.data.talkers.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.display_name;
                        option.textContent = `${t.display_name} (${t.message_count} æ¡æ¶ˆæ¯)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ç¾¤èŠåˆ—è¡¨å¤±è´¥:', error);
            }
            
            // åŠ è½½æ¨¡æ¿åˆ—è¡¨
            try {
                const response = await axios.get('/api/templates');
                if (response.data.ok) {
                    const select = document.getElementById('mapping-template');
                    select.innerHTML = '<option value="">-- é€‰æ‹©æ¨¡æ¿ --</option>';
                    response.data.templates.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = `${t.name} [${t.llm_type}]`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥:', error);
            }
            
            document.getElementById('mapping-llm-type').value = '';
            document.getElementById('mapping-modal').classList.remove('hidden');
        }
        
        function hideMappingModal() {
            document.getElementById('mapping-modal').classList.add('hidden');
        }
        
        async function saveMapping() {
            const talker = document.getElementById('mapping-talker').value;
            const templateId = document.getElementById('mapping-template').value;
            const llmType = document.getElementById('mapping-llm-type').value || null;
            
            if (!talker || !templateId) {
                alert('è¯·é€‰æ‹©ç¾¤èŠå’Œæ¨¡æ¿');
                return;
            }
            
            try {
                const response = await axios.post('/api/template-mappings', {
                    talker,
                    template_id: templateId,
                    llm_type: llmType
                });
                
                if (response.data.ok) {
                    alert('âœ… ä¿å­˜æˆåŠŸï¼');
                    hideMappingModal();
                    loadMappings();
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜æ˜ å°„å¤±è´¥:', error);
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        async function deleteMapping(talker) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¾¤èŠ "${talker}" çš„æ¨¡æ¿æ˜ å°„å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await axios.delete(`/api/template-mappings/${encodeURIComponent(talker)}`);
                if (response.data.ok) {
                    alert('âœ… åˆ é™¤æˆåŠŸï¼');
                    loadMappings();
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥: ' + response.data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤æ˜ å°„å¤±è´¥:', error);
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>

