# 日志分析 - 2026-01-01 16:15

## 关键性能瓶颈

### 1. ChatGPT 消息确认慢（31.62秒）【高优先级】

**问题**：
- `16:16:14` 发送完成
- `16:16:44` 触发手动检查点（30秒后）
- `16:16:45` 确认完成（31.62秒）
- 快速路径（textbox cleared, stop button）都没有生效

**原因分析**：
- `wait_for_function` 和 `wait_for_selector` 可能超时（3秒和2秒）
- 如果快速路径都失败，会进入正常检测流程，需要等待 `user_count()` 增加
- `user_count()` 检测可能需要多次重试，每次都有超时

**优化方案**：
1. 增加快速路径的超时时间（从3秒增加到5秒）
2. 优化 `wait_for_function` 的选择器，确保能正确检测
3. 添加更多快速检测路径（例如检查输入框的 `value` 属性）

### 2. Gemini 发送按钮警告持续出现【高优先级】

**问题**：
- `16:15:20` 和 `16:16:33` 都出现 `warning - textbox still has content after button click`
- 说明按钮点击后，内容没有清空，可能发送失败

**原因分析**：
- JS 注入后，Angular 的状态可能没有同步
- 按钮点击可能没有触发发送
- 需要更可靠的发送确认机制

**优化方案**：
1. 在按钮点击后，等待更长时间（从0.5秒增加到1.0秒）
2. 检查按钮是否变为 disabled 状态（说明已发送）
3. 如果按钮点击失败，立即尝试 Enter 或 Ctrl+Enter

### 3. Gemini 响应检测问题【中优先级】

**问题**：
- `16:17:17` 显示 `response stabilized (len=2053)`，但这是上一个响应的长度
- 说明检测到了旧的响应，而不是新的响应

**原因分析**：
- `_last_text()` 可能返回的是上一个响应的文本
- 需要确保获取的是最新的响应

**优化方案**：
1. 在发送前记录最后一个响应的文本长度
2. 在检测新响应时，确保长度明显增加（>10%）
3. 如果检测到的是旧响应，继续等待

### 4. ChatGPT 发送阶段慢（20.08秒）【中优先级】

**问题**：
- `16:15:57` 开始发送
- `16:16:14` 发送完成（20秒）
- 说明 Control+Enter 可能没有立即生效

**原因分析**：
- `send_phase_max_s` 设置为 8 秒，但实际用了 20 秒
- 说明在 8 秒后跳过了按钮尝试，但 Control+Enter 可能已经生效

**优化方案**：
1. 在跳过按钮尝试后，检查是否已经发送（检查 `user_count`）
2. 如果已经发送，立即返回，不需要等待

### 5. Future exception was never retrieved【低优先级】

**问题**：
- `TimeoutError: Timeout 3000ms exceeded.`
- 说明某个操作超时但没有被正确处理

**原因分析**：
- 可能是 `wait_for_function` 或 `wait_for_selector` 超时
- 异常没有被正确捕获

**优化方案**：
1. 确保所有异步操作都有异常处理
2. 使用 `asyncio.wait_for` 包装所有可能超时的操作

